<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Liquid Plastic OS 1.x</title>
<style>
:root{
  --accent:#4aa8ff;
  --bg-gradient:radial-gradient(circle at top,#182235 0%,#050711 55%,#020308 100%);
  --text-main:#f9fafb;
  --text-sub:#9ca3af;
  --glass-opacity:0.80;
  --glass-border-alpha:0.50;
  --icon-glass-opacity:0.80;
  --radius:18px;
}

/* Basic reset */
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
  font-family:system-ui,-apple-system,BlinkMacSystemFont,"SF Pro Text",Segoe UI,Roboto,Arial;
  background:var(--bg-gradient);
  color:var(--text-main);
  overflow:hidden;
  -webkit-font-smoothing:antialiased;
}

/* Neon hover glow for primary interactive elements */
button, .task-btn, .theme-btn, .settings-wall-btn, .settings-accent-btn, .settings-radio-btn, .start-tile, .tb-app, .win-btn, .start-account {
  transition: box-shadow .12s, background .12s, transform .08s, border-color .12s;
}
button:hover, .task-btn:hover, .theme-btn:hover, .settings-wall-btn:hover, .settings-accent-btn:hover, .settings-radio-btn:hover, .start-tile:hover, .tb-app:hover, .win-btn:hover, .start-account:hover {
  box-shadow:0 0 18px rgba(59,130,246,0.95);
  border-color:var(--accent);
  transform:translateY(-1px);
}

/* Glass surfaces */
.glass-ui{
  background:rgba(15,23,42,var(--glass-opacity));
  border-radius:var(--radius);
  border:1px solid rgba(148,163,184,var(--glass-border-alpha));
  backdrop-filter:blur(18px) saturate(160%);
  -webkit-backdrop-filter:blur(18px) saturate(160%);
}
.glass-win{
  position:absolute;
  background:rgba(15,23,42,0.92);
  border-radius:var(--radius);
  border:1px solid rgba(148,163,184,0.55);
  backdrop-filter:blur(20px) saturate(160%);
  -webkit-backdrop-filter:blur(20px) saturate(160%);
  box-shadow:0 22px 60px rgba(0,0,0,.75);
}

/* Desktop & background glows */
.desktop{position:fixed;inset:0;overflow:hidden;background:var(--bg-gradient)}
.glow{position:absolute;border-radius:999px;filter:blur(60px);opacity:.6;mix-blend-mode:screen}
.g1{width:40vw;height:40vw;background:radial-gradient(circle,#38bdf8,transparent 60%);top:-10%;left:-10%}
.g2{width:32vw;height:32vw;background:radial-gradient(circle,#fb7185,transparent 60%);bottom:-12%;right:-5%}
.g3{width:26vw;height:26vw;background:radial-gradient(circle,#5eead4,transparent 60%);bottom:10%;left:15%}

/* Lockscreen */
#lockscreen{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:1200;backdrop-filter:blur(20px)}
#lockscreen.visible{display:flex}
.lock-panel{width:420px;padding:28px}
.lock-panel-inner{border-radius:26px;border:1px solid rgba(148,163,184,.6);background:rgba(15,23,42,.94);padding:20px;text-align:center}
.lock-time{font-size:56px;font-weight:600}
.lock-date{margin-top:6px;color:var(--text-sub)}
.account-pill{display:flex;align-items:center;gap:10px;margin-top:18px;padding:10px 14px;border-radius:999px;background:rgba(15,23,42,.9);cursor:pointer}
.avatar{width:36px;height:36px;border-radius:999px;background:conic-gradient(from 140deg,#38bdf8,#a855f7,#f97316,#22c55e);display:flex;align-items:center;justify-content:center;color:#020617;font-weight:700}

/* Desktop icons */
#desktopIcons{position:fixed;inset:0;padding:8px;pointer-events:auto}
.icon{position:absolute;width:84px;text-align:center;font-size:12px;pointer-events:auto;cursor:pointer;user-select:none}
.icon-body{width:48px;height:48px;margin:0 auto 6px;border-radius:14px;background:conic-gradient(from 210deg,#38bdf8,#22c55e,#f97316,#ec4899);position:relative;overflow:hidden;box-shadow:0 12px 26px rgba(0,0,0,.7)}
.icon-body::after{content:"";position:absolute;inset:2px;border-radius:inherit;background:rgba(15,23,42,var(--icon-glass-opacity))}
.icon-label{color:var(--text-main);font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.icon.selected .icon-body{outline:2px solid var(--accent)}
.icon.folder .icon-body{background:rgba(15,23,42,.88);border:1px solid rgba(148,163,184,.6)}

/* Selection box */
#selectBox{position:fixed;border:1px solid rgba(148,163,184,.8);background:rgba(59,130,246,0.12);display:none;pointer-events:none;z-index:60}

/* Context menu */
#ctxMenu{position:fixed;min-width:160px;display:none;z-index:1400;font-size:13px}
#ctxMenu .inner{padding:6px;border-radius:10px}
.ctx-item{padding:8px 10px;color:var(--text-main);cursor:pointer}
.ctx-item:hover{background:var(--accent);color:#020617}

/* Taskbar */
#taskbar{position:fixed;left:0;right:0;bottom:0;height:46px;padding:6px 12px 4px;display:flex;align-items:center;gap:8px;z-index:900;background:rgba(15,23,42,var(--glass-opacity));border-top:1px solid rgba(148,163,184,var(--glass-border-alpha));backdrop-filter:blur(18px);overflow:visible}
.task-left,.task-mid,.task-right{display:flex;align-items:center}
.task-mid{flex:1;justify-content:center}
.task-btn{border-radius:999px;border:1px solid rgba(148,163,184,.5);padding:6px 12px;background:rgba(15,23,42,.94);cursor:pointer}
.taskbar-apps{display:flex;gap:6px;align-items:center}
.tb-app{border-radius:999px;padding:6px 10px;background:rgba(15,23,42,.9);cursor:pointer}
.tb-app.active{box-shadow:0 0 12px rgba(74,168,255,0.18);border-color:rgba(74,168,255,0.6)}

/* Start menu */
#startMenu{position:fixed;left:10px;bottom:58px;width:360px;max-height:520px;display:none;z-index:950}
#startMenu .inner{padding:10px;border-radius:18px}
.start-header{display:flex;justify-content:space-between;align-items:flex-start;font-size:13px;color:var(--text-sub);margin-bottom:8px}
.start-account{display:flex;align-items:center;gap:8px;padding:6px 10px;border-radius:18px;background:rgba(15,23,42,0.9);border:1px solid rgba(148,163,184,0.7);cursor:pointer}
.start-account:hover{box-shadow:0 0 18px rgba(59,130,246,0.95)}
.start-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:8px}
.start-tile{border-radius:14px;padding:8px;text-align:center;background:rgba(15,23,42,.9);border:1px solid rgba(148,163,184,.5);cursor:pointer}

/* Notifications */
#notifPanel{position:fixed;right:10px;bottom:58px;width:280px;max-height:360px;display:none;z-index:950}
#notifPanel .inner{padding:8px;border-radius:12px}

/* Windows */
.window{position:absolute;min-width:380px;min-height:220px;display:none;flex-direction:column;border-radius:var(--radius);overflow:hidden;z-index:500}
.window.visible{display:flex}
.win-header{display:flex;align-items:center;padding:8px 10px;border-bottom:1px solid rgba(148,163,184,.2);cursor:move}
.win-title{font-size:13px;color:var(--text-sub)}
.win-controls{margin-left:auto;display:flex;gap:6px}
.win-btn{width:26px;height:20px;border-radius:6px;border:1px solid rgba(148,163,184,.5);background:rgba(15,23,42,.9);cursor:pointer}

/* Settings */
.settings-app{display:flex;height:100%;font-size:13px}
.settings-sidebar{width:160px;border-right:1px solid rgba(55,65,81,.9);padding:8px;display:flex;flex-direction:column;gap:6px}
.settings-item{padding:8px;border-radius:6px;cursor:pointer}
.settings-item:hover{background:rgba(31,41,55,.9)}
.settings-item-active{background:rgba(37,99,235,.6)}
.settings-main{flex:1;padding:12px;overflow:auto}
.settings-section{margin-top:10px}
.settings-toggle{width:36px;height:18px;border-radius:999px;border:1px solid rgba(75,85,99,.9);position:relative;background:rgba(15,23,42,.95);cursor:pointer}
.settings-toggle-knob{position:absolute;width:16px;height:16px;border-radius:999px;background:#e5e7eb;top:1px;left:1px;transition:transform .12s}
.settings-toggle.on .settings-toggle-knob{transform:translateX(18px)}
.glass-slider{width:100%;margin-top:6px}

/* Store */
.store-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px;margin-top:8px}
.store-card{border-radius:10px;padding:8px;border:1px solid rgba(55,65,81,.9);background:rgba(15,23,42,.95)}

/* Toast */
#toast{position:fixed;right:12px;bottom:64px;background:rgba(15,23,42,.98);padding:8px 10px;border-radius:8px;border:1px solid rgba(59,130,246,.8);z-index:1000;opacity:0;transform:translateY(8px);transition:opacity .12s,transform .12s}
#toast.show{opacity:1;transform:translateY(0)}
</style>
</head>
<body>

<!-- BIOS -->
<div id="bios" class="glass-ui" style="padding:18px;z-index:1500;">
  <div style="font-weight:700;margin-bottom:6px">Liquid Plastic UEFI BIOS v1.0</div>
  <div style="font-size:13px;color:var(--text-sub)">Virtual Glass Core • 8 GB</div>
  <div style="margin-top:12px;height:8px;border-radius:999px;background:#020617;overflow:hidden">
    <div id="bios-bar-inner" style="height:100%;width:0;background:linear-gradient(90deg,var(--accent),#22c55e);transition:width .12s"></div>
  </div>
  <div style="margin-top:10px;color:var(--text-sub)">Press any key or click to continue...</div>
</div>

<!-- Lockscreen -->
<div id="lockscreen">
  <div class="lock-panel">
    <div class="lock-panel-inner">
      <div class="lock-time" id="lockTime">--:--</div>
      <div class="lock-date" id="lockDate">--</div>
      <div class="account-pill" id="lockAccount">
        <div class="avatar">C</div>
        <div style="text-align:left">
          <div style="font-weight:600">Curtis</div>
          <div style="font-size:12px;color:var(--text-sub)">Liquid Plastic</div>
        </div>
      </div>
      <div style="margin-top:10px;font-size:13px;color:var(--text-sub)">Click your name or press any key to sign in</div>
    </div>
  </div>
</div>

<!-- Desktop -->
<div class="desktop" id="desktopRoot">
  <div class="glow g1"></div>
  <div class="glow g2"></div>
  <div class="glow g3"></div>
  <div id="desktopIcons"></div>
</div>

<div id="selectBox"></div>
<div id="ctxMenu"><div class="inner glass-ui"></div></div>
<div id="startMenu"><div class="inner glass-ui"></div></div>
<div id="notifPanel"><div class="inner glass-ui"></div></div>
<div id="taskbar"></div>
<div id="toast"></div>

<script>
/* -------------------------
   Utilities & state
   ------------------------- */
const $ = (s, r=document) => r.querySelector(s);
const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));

const OS = {
  config: {
    desktopGrid: 80,
    clock24: false,
    taskbarAutohide: false,
    glassLevel: 0.8
  },
  state: {
    bootDone: false,
    locked: true,
    desktopIcons: [], // intentionally empty by default
    windows: [],
    activeWindow: null,
    nextZ: 200,
    apps: {},
    notifications: [],
    startMenuOpen: false,
    notifOpen: false,
    recycleBin: [],
    passwordEnabled: false,
    passwordHash: null
  }
};

/* load persisted glass & password */
(function(){
  try{
    const g = localStorage.getItem("lp-glass");
    if(g!==null){ const n=Number(g); if(!isNaN(n)) OS.config.glassLevel = n; }
    const pe = localStorage.getItem("lp-password-enabled");
    if(pe==="1") OS.state.passwordEnabled = true;
    const ph = localStorage.getItem("lp-password-hash");
    if(ph) OS.state.passwordHash = ph;
  }catch(e){}
})();

function showToast(msg){
  const t = $("#toast");
  if(!t) return;
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"),2200);
}
function notify(title, message){
  OS.state.notifications.unshift({id:Date.now()+"-"+Math.random().toString(16).slice(2), title, message, time:new Date()});
  renderNotifications();
  renderTaskbar();
}

/* -------------------------
   BIOS boot
   ------------------------- */
function startBoot(){
  const bios = document.getElementById("bios");
  const bar = document.getElementById("bios-bar-inner");
  if(!bios || !bar){ finishBoot(); return; }
  let p=0;
  const iv=setInterval(()=>{
    p+=6; if(p>100) p=100;
    bar.style.width = p + "%";
    if(p>=100){ clearInterval(iv); setTimeout(finishBoot, 300); }
  },70);
  function finishBoot(){
    bios.remove();
    initDesktop();
    showLockscreen(true);
    notify("Welcome","Liquid Plastic OS ready.");
  }
  window.addEventListener("keydown", ()=>{ clearInterval(iv); finishBoot(); }, {once:true});
  window.addEventListener("click", ()=>{ clearInterval(iv); finishBoot(); }, {once:true});
}

/* -------------------------
   Clock / Lockscreen (password-aware)
   ------------------------- */
function updateLockTime(){
  const now=new Date();
  const use24 = OS.config.clock24;
  const h24 = now.getHours();
  const h = use24 ? String(h24).padStart(2,"0") : (h24%12||12);
  const m = String(now.getMinutes()).padStart(2,"0");
  $("#lockTime").textContent = use24 ? `${h}:${m}` : `${h}:${m} ${h24>=12?"PM":"AM"}`;
  $("#lockDate").textContent = now.toLocaleDateString(undefined,{weekday:"long",month:"long",day:"numeric"});
}
let lockInterval = null;
function showLockscreen(first=false){
  OS.state.locked = true;
  const ls = $("#lockscreen");
  if(!ls) return;
  ls.classList.add("visible");
  updateLockTime();
  if(lockInterval) clearInterval(lockInterval);
  lockInterval = setInterval(()=>{ if(OS.state.locked) updateLockTime(); },30000);

  const unlock = async ()=>{
    if(!OS.state.locked) return;
    if(OS.state.passwordEnabled && OS.state.passwordHash){
      const attempt = prompt("Enter password to unlock:");
      if(attempt===null) return;
      if(simpleHash(attempt) !== OS.state.passwordHash){ alert("Incorrect password."); return; }
    }
    OS.state.locked = false;
    ls.classList.remove("visible");
  };
  $("#lockAccount").onclick = unlock;
  window.onkeydown = (e)=>{ if(OS.state.locked) unlock(); };
}

/* simple non-crypto hash for demo */
function simpleHash(s){
  let h=2166136261;
  for(let i=0;i<s.length;i++){ h ^= s.charCodeAt(i); h += (h<<1)+(h<<4)+(h<<7)+(h<<8)+(h<<24); }
  return (h>>>0).toString(16);
}

/* -------------------------
   Desktop icons (empty by default)
   ------------------------- */
function seedDesktopIcons(){
  OS.state.desktopIcons = []; // intentionally empty; user drags from Start to create shortcuts
}
function renderDesktopIcons(){
  const layer = $("#desktopIcons");
  if(!layer) return;
  layer.innerHTML = "";
  OS.state.desktopIcons.forEach((icon, idx)=>{
    const el = document.createElement("div");
    el.className = "icon";
    if(icon.type==="folder") el.classList.add("folder");
    el.dataset.index = idx;
    el.style.left = icon.x + "px";
    el.style.top = icon.y + "px";

    let body = '<div class="icon-body"></div>';
    if(icon.type==="folder"){
      body = `<div class="icon-body"><div style="position:absolute;inset:6px;display:grid;grid-template-columns:repeat(2,1fr);grid-gap:4px">${(icon.children||[]).slice(0,4).map(()=>'<div style="border-radius:6px;background:linear-gradient(90deg,#38bdf8,#22c55e)"></div>').join('')}</div></div>`;
    }

    el.innerHTML = body + `<div class="icon-label" data-label-index="${idx}">${escapeHtml(icon.name)}</div>`;
    if(icon.selected) el.classList.add("selected");

    // selection (single/multi)
    el.addEventListener("mousedown", (e)=>{
      if(e.button!==0) return;
      e.stopPropagation();
      const multi = e.ctrlKey || e.metaKey || e.shiftKey;
      if(!multi){
        OS.state.desktopIcons.forEach(i=>i.selected=false);
      }
      icon.selected = !icon.selected;
      renderDesktopIcons();
    });

    // double click opens
    el.addEventListener("dblclick", ()=>{
      if(icon.type==="folder") openAppFolder(icon);
      else if(icon.appId) openApp(icon.appId);
    });

    // context menu
    el.addEventListener("contextmenu", (e)=>{
      e.preventDefault(); e.stopPropagation();
      showDesktopContextMenuForIcon(icon, idx, e.clientX, e.clientY);
    });

    layer.appendChild(el);
  });
}

/* inline rename like Windows */
function startRenameIcon(index){
  const el = $(`.icon[data-index="${index}"]`);
  if(!el) return;
  const label = el.querySelector(".icon-label");
  if(!label) return;
  const old = label.textContent;
  const input = document.createElement("input");
  input.type = "text";
  input.value = old;
  input.style.width = "100%";
  input.style.background = "transparent";
  input.style.border = "1px solid rgba(148,163,184,.4)";
  input.style.color = "var(--text-main)";
  input.style.borderRadius = "6px";
  input.style.padding = "2px";
  label.replaceWith(input);
  input.focus(); input.select();
  function finish(){
    const val = input.value.trim() || old;
    OS.state.desktopIcons[index].name = val;
    renderDesktopIcons();
  }
  input.addEventListener("blur", finish);
  input.addEventListener("keydown", (e)=>{
    if(e.key==="Enter") input.blur();
    if(e.key==="Escape") renderDesktopIcons();
  });
}

/* -------------------------
   Selection box
   ------------------------- */
let selStartX=0, selStartY=0, selecting=false;
function enableSelectionBox(){
  const box = $("#selectBox");
  document.addEventListener("mousedown",(e)=>{
    if(e.button!==0) return;
    if(e.target.closest(".window")) return;
    if(e.target.closest(".icon") || e.target.closest("#taskbar") || e.target.closest("#startMenu") || e.target.closest("#notifPanel")) return;
    selecting = true;
    selStartX = e.clientX; selStartY = e.clientY;
    box.style.left = selStartX + "px"; box.style.top = selStartY + "px";
    box.style.width = "0px"; box.style.height = "0px"; box.style.display = "block";
    OS.state.desktopIcons.forEach(i=>i.selected=false);
    renderDesktopIcons();
  });
  document.addEventListener("mousemove",(e)=>{
    if(!selecting) return;
    const x = Math.min(selStartX, e.clientX);
    const y = Math.min(selStartY, e.clientY);
    const w = Math.abs(e.clientX - selStartX);
    const h = Math.abs(e.clientY - selStartY);
    box.style.left = x + "px"; box.style.top = y + "px"; box.style.width = w + "px"; box.style.height = h + "px";
    $$(".icon").forEach(el=>{
      const rect = el.getBoundingClientRect();
      const overlap = rect.left < x+w && rect.right > x && rect.top < y+h && rect.bottom > y;
      const idx = Number(el.dataset.index);
      OS.state.desktopIcons[idx].selected = overlap;
    });
    renderDesktopIcons();
  });
  document.addEventListener("mouseup",()=>{
    if(selecting){ selecting=false; box.style.display="none"; }
  });
}

/* -------------------------
   Dragging icons (multi-select supported)
   ------------------------- */
let draggingIcons=false, dragStartX=0, dragStartY=0, iconStartPositions=[];
function enableIconDragging(){
  document.addEventListener("mousedown",(e)=>{
    if(e.button!==0) return;
    const iconEl = e.target.closest(".icon");
    if(!iconEl) return;
    const idx = Number(iconEl.dataset.index);
    const icon = OS.state.desktopIcons[idx];
    if(!icon) return;

    // if clicked icon not selected, select only it
    if(!icon.selected){
      OS.state.desktopIcons.forEach(i=>i.selected=false);
      icon.selected = true;
      renderDesktopIcons();
    }

    draggingIcons = true;
    dragStartX = e.clientX; dragStartY = e.clientY;
    iconStartPositions = OS.state.desktopIcons.map((i, index)=>({ index, x:i.x, y:i.y, selected:i.selected })).filter(i=>i.selected);
    document.body.style.userSelect = "none";
  });

  document.addEventListener("mousemove",(e)=>{
    if(!draggingIcons) return;
    const dx = e.clientX - dragStartX;
    const dy = e.clientY - dragStartY;
    iconStartPositions.forEach(info=>{
      const icon = OS.state.desktopIcons[info.index];
      icon.x = info.x + dx;
      icon.y = info.y + dy;
    });
    renderDesktopIcons();
  });

  document.addEventListener("mouseup",(e)=>{
    if(!draggingIcons) return;
    draggingIcons = false;
    document.body.style.userSelect = "";
    const grid = OS.config.desktopGrid || 80;

    // if single dragged onto another -> folder logic
    const selected = OS.state.desktopIcons.filter(i=>i.selected);
    if(selected.length===1){
      const dragged = selected[0];
      const draggedRect = getIconRect(dragged);
      const target = OS.state.desktopIcons.find(i=>i!==dragged && overlapRect(draggedRect, getIconRect(i)));
      if(target){
        if(target.type !== "folder"){
          const folder = { id:"folder-"+Date.now(), name:"App Folder", appId:null, x:target.x, y:target.y, selected:false, type:"folder", children:[target.appId, dragged.appId].filter(Boolean) };
          OS.state.desktopIcons = OS.state.desktopIcons.filter(i=>i!==dragged && i!==target);
          OS.state.desktopIcons.push(folder);
        }else{
          if(dragged.appId && !target.children.includes(dragged.appId)) target.children.push(dragged.appId);
          OS.state.desktopIcons = OS.state.desktopIcons.filter(i=>i!==dragged);
        }
        renderDesktopIcons();
        return;
      }
    }

    // snap to grid for all moved icons
    OS.state.desktopIcons.forEach(icon=>{
      icon.x = Math.round(icon.x / grid) * grid;
      icon.y = Math.round(icon.y / grid) * grid;
    });
    renderDesktopIcons();
  });
}
function getIconRect(icon){
  const idx = OS.state.desktopIcons.indexOf(icon);
  const el = $(`.icon[data-index="${idx}"]`);
  return el ? el.getBoundingClientRect() : {left:0,top:0,right:0,bottom:0};
}
function overlapRect(a,b){ return a.left < b.right && a.right > b.left && a.top < b.bottom && a.bottom > b.top; }

/* -------------------------
   Desktop context menu
   ------------------------- */
function showDesktopContextMenuForIcon(icon, index, x, y){
  const menu = $("#ctxMenu");
  const inner = menu.querySelector(".inner");
  inner.innerHTML = `
    <div class="ctx-item" data-act="open">Open</div>
    <div class="ctx-item" data-act="rename">Rename</div>
    <div class="ctx-item" data-act="pin">Pin / Unpin from Start</div>
    <div class="ctx-item" data-act="remove">Remove from Desktop</div>
  `;
  menu.style.left = x + "px"; menu.style.top = y + "px"; menu.style.display = "block";

  inner.querySelectorAll(".ctx-item").forEach(item=>{
    item.onclick = ()=>{
      const a = item.dataset.act;
      if(a==="open"){ if(icon.type==="folder") openAppFolder(icon); else if(icon.appId) openApp(icon.appId); }
      if(a==="rename"){ startRenameIcon(index); }
      if(a==="pin"){ togglePinStart(icon.appId); }
      if(a==="remove"){ moveToRecycleBin(icon); OS.state.desktopIcons.splice(index,1); renderRecycleBinList(); }
      renderDesktopIcons();
      menu.style.display = "none";
    };
  });
}

/* -------------------------
   Window manager
   ------------------------- */
function createWindow(appId, title, contentNode){
  const win = document.createElement("div");
  win.className = "window glass-win";
  win.dataset.appId = appId;
  const header = document.createElement("div"); header.className = "win-header";
  header.innerHTML = `<div class="win-title">${escapeHtml(title)}</div><div class="win-controls"><button class="win-btn" data-min>-</button><button class="win-btn" data-max>□</button><button class="win-btn" data-close>×</button></div>`;
  const body = document.createElement("div"); body.className = "win-body";
  if(contentNode) body.appendChild(contentNode);
  const resize = document.createElement("div"); resize.style.position="absolute"; resize.style.right="6px"; resize.style.bottom="6px"; resize.style.width="12px"; resize.style.height="12px"; resize.style.cursor="nwse-resize";
  win.appendChild(header); win.appendChild(body); win.appendChild(resize);
  document.body.appendChild(win);

  win.style.left = (120 + OS.state.windows.length*28) + "px";
  win.style.top = (80 + OS.state.windows.length*22) + "px";
  win.style.zIndex = OS.state.nextZ++;
  OS.state.windows.push(win);

  enableWindowDragging(win, header);
  hookWindowControls(win);
  enableWindowResize(win, resize);
  focusWindow(win);
  requestAnimationFrame(()=>{ win.classList.add("visible"); });

  renderTaskbar();
  return win;
}
function focusWindow(win){
  OS.state.windows.forEach(w=>w.style.zIndex = 200);
  win.style.zIndex = OS.state.nextZ++;
  OS.state.activeWindow = win;
  renderTaskbar();
}
function hookWindowControls(win){
  const btnMin = win.querySelector("[data-min]");
  const btnMax = win.querySelector("[data-max]");
  const btnClose = win.querySelector("[data-close]");
  btnMin.onclick = ()=>{ win.style.display = "none"; renderTaskbar(); };
  btnMax.onclick = ()=>{
    if(win.classList.contains("maximized")){
      win.classList.remove("maximized"); win.style.position="absolute"; win.style.left="120px"; win.style.top="80px"; win.style.width=""; win.style.height="";
    }else{
      win.classList.add("maximized"); win.style.position="fixed"; win.style.left="0"; win.style.top="0"; win.style.width="100vw"; win.style.height="100vh";
    }
  };
  btnClose.onclick = ()=>{
    win.remove();
    OS.state.windows = OS.state.windows.filter(w=>w!==win);
    if(OS.state.activeWindow===win) OS.state.activeWindow=null;
    renderTaskbar();
  };
  win.addEventListener("mousedown", ()=>focusWindow(win));
}
function enableWindowDragging(win, header){
  let dragging=false, sx=0, sy=0, wl=0, wt=0;
  header.addEventListener("mousedown",(e)=>{
    if(e.button!==0) return;
    dragging=true; sx=e.clientX; sy=e.clientY;
    const r = win.getBoundingClientRect(); wl=r.left; wt=r.top;
    win.classList.add("dragging"); document.body.style.userSelect="none";
  });
  document.addEventListener("mousemove",(e)=>{ if(!dragging) return; win.style.left = (wl + (e.clientX - sx)) + "px"; win.style.top = (wt + (e.clientY - sy)) + "px"; });
  document.addEventListener("mouseup",()=>{ if(!dragging) return; dragging=false; win.classList.remove("dragging"); document.body.style.userSelect=""; });
}
function enableWindowResize(win, handle){
  let resizing=false, startX=0, startY=0, startW=0, startH=0;
  handle.addEventListener("mousedown",(e)=>{ e.stopPropagation(); e.preventDefault(); resizing=true; startX=e.clientX; startY=e.clientY; const r=win.getBoundingClientRect(); startW=r.width; startH=r.height; document.body.style.userSelect="none"; });
  document.addEventListener("mousemove",(e)=>{ if(!resizing) return; win.style.width = Math.max(320, startW + (e.clientX - startX)) + "px"; win.style.height = Math.max(200, startH + (e.clientY - startY)) + "px"; });
  document.addEventListener("mouseup",()=>{ if(!resizing) return; resizing=false; document.body.style.userSelect=""; });
}

/* -------------------------
   App registry & openApp
   ------------------------- */
function registerApp(id, def){ OS.state.apps[id] = def; }
function openApp(id){
  const app = OS.state.apps[id];
  if(!app){ showToast(`App "${id}" not installed.`); return null; }
  const existing = OS.state.windows.find(w=>w.dataset.appId===id);
  if(existing){ existing.style.display = "flex"; focusWindow(existing); return existing; }
  const content = app.createContent();
  return createWindow(id, app.title, content);
}

/* -------------------------
   Built-in apps (full implementations)
   ------------------------- */

/* Settings (full) */
registerApp("settings", {
  title: "Settings",
  createContent(){
    const root = document.createElement("div");
    root.className = "settings-app";
    root.innerHTML = `
      <div class="settings-sidebar">
        <div class="settings-item" data-panel="appearance">Appearance</div>
        <div class="settings-item" data-panel="system">System</div>
        <div class="settings-item" data-panel="account">Account</div>
        <div class="settings-item" data-panel="glass">Glass</div>
      </div>
      <div class="settings-main">
        <div class="settings-panel" data-panel-id="appearance"></div>
        <div class="settings-panel" data-panel-id="system"></div>
        <div class="settings-panel" data-panel-id="account"></div>
        <div class="settings-panel" data-panel-id="glass"></div>
      </div>
    `;
    setupSettings(root);
    return root;
  }
});
function setupSettings(root){
  const items = Array.from(root.querySelectorAll(".settings-item"));
  const panels = {
    appearance: root.querySelector('.settings-panel[data-panel-id="appearance"]'),
    system: root.querySelector('.settings-panel[data-panel-id="system"]'),
    account: root.querySelector('.settings-panel[data-panel-id="account"]'),
    glass: root.querySelector('.settings-panel[data-panel-id="glass"]')
  };
  renderAppearancePanel(panels.appearance);
  renderSystemPanel(panels.system);
  renderAccountPanel(panels.account);
  renderGlassPanel(panels.glass);
  function show(name){ Object.values(panels).forEach(p=>p.style.display="none"); panels[name].style.display="block"; }
  items.forEach(it=>it.addEventListener("click", ()=>{
    items.forEach(i=>i.classList.remove("settings-item-active"));
    it.classList.add("settings-item-active");
    show(it.dataset.panel);
  }));
  items[0].classList.add("settings-item-active");
  show("appearance");
}
function renderAppearancePanel(panel){
  panel.innerHTML = `
    <h2>Appearance</h2>
    <div class="settings-section">
      <div class="setting-group-title">Wallpaper</div>
      <div class="setting-options">
        <button class="settings-wall-btn" data-wall="default">Default</button>
        <button class="settings-wall-btn" data-wall="aurora">Aurora</button>
        <button class="settings-wall-btn" data-wall="forest">Forest</button>
        <button class="settings-wall-btn" data-wall="sunset">Sunset</button>
        <button class="settings-wall-btn" data-wall="mono">Mono</button>
      </div>
    </div>
    <div class="settings-section">
      <div class="setting-group-title">Accent color</div>
      <div class="setting-options">
        <button class="settings-accent-btn" data-accent="#4aa8ff">Blue</button>
        <button class="settings-accent-btn" data-accent="#22c55e">Green</button>
        <button class="settings-accent-btn" data-accent="#f97316">Orange</button>
        <button class="settings-accent-btn" data-accent="#ec4899">Pink</button>
        <button class="settings-accent-btn" data-accent="#a855f7">Purple</button>
      </div>
    </div>
    <div class="settings-section">
      <div class="setting-group-title">Window corners</div>
      <div class="setting-options">
        <button class="settings-radio-btn" data-corners="rounded">Rounded</button>
        <button class="settings-radio-btn" data-corners="sharp">Sharp</button>
      </div>
    </div>
    <div class="settings-section">
      <div class="setting-group-title">Clock format</div>
      <div class="setting-options">
        <button class="settings-radio-btn" data-clock="12">12 hour</button>
        <button class="settings-radio-btn" data-clock="24">24 hour</button>
      </div>
    </div>
  `;
  panel.querySelectorAll(".settings-wall-btn").forEach(btn=>{
    btn.onclick = ()=>{
      const w = btn.dataset.wall;
      const desktop = $("#desktopRoot");
      if(w==="default") desktop.style.background = "var(--bg-gradient)";
      if(w==="aurora") desktop.style.background = "radial-gradient(circle at top,#1e3a8a,#020617)";
      if(w==="forest") desktop.style.background = "radial-gradient(circle at top,#064e3b,#020617)";
      if(w==="sunset") desktop.style.background = "radial-gradient(circle at top,#b91c1c,#020617)";
      if(w==="mono") desktop.style.background = "radial-gradient(circle at top,#111827,#020617)";
      panel.querySelectorAll(".settings-wall-btn").forEach(x=>x.classList.remove("active"));
      btn.classList.add("active");
    };
  });
  panel.querySelectorAll(".settings-accent-btn").forEach(btn=>{
    btn.onclick = ()=>{ document.documentElement.style.setProperty("--accent", btn.dataset.accent); panel.querySelectorAll(".settings-accent-btn").forEach(x=>x.classList.remove("active")); btn.classList.add("active"); };
  });
  panel.querySelectorAll(".settings-radio-btn[data-corners]").forEach(btn=>{
    btn.onclick = ()=>{ document.documentElement.style.setProperty("--radius", btn.dataset.corners==="rounded"?"18px":"6px"); panel.querySelectorAll(".settings-radio-btn[data-corners]").forEach(x=>x.classList.remove("active")); btn.classList.add("active"); };
  });
  panel.querySelectorAll(".settings-radio-btn[data-clock]").forEach(btn=>{
    btn.onclick = ()=>{ OS.config.clock24 = btn.dataset.clock==="24"; updateLockTime(); panel.querySelectorAll(".settings-radio-btn[data-clock]").forEach(x=>x.classList.remove("active")); btn.classList.add("active"); };
  });
}
function renderSystemPanel(panel){
  panel.innerHTML = `
    <h2>System</h2>
    <div class="settings-section">
      <div class="settings-toggle-row">
        <div class="settings-toggle" id="sysTaskbarAuto"><div class="settings-toggle-knob"></div></div>
        <div>Taskbar auto-hide</div>
      </div>
      <div style="font-size:12px;color:var(--text-sub);margin-top:6px;">Hide taskbar until cursor is at the bottom edge (visual only).</div>
    </div>
  `;
  const toggle = panel.querySelector("#sysTaskbarAuto");
  function update(){ toggle.classList.toggle("on", OS.config.taskbarAutohide); }
  toggle.onclick = ()=>{ OS.config.taskbarAutohide = !OS.config.taskbarAutohide; update(); showToast("Taskbar auto-hide toggled (visual only)."); };
  update();
}
function renderAccountPanel(panel){
  panel.innerHTML = `
    <h2>Account</h2>
    <div class="settings-section">
      <div style="margin-bottom:8px;">Current profile picture</div>
      <div style="display:flex;gap:8px;align-items:center">
        <div style="width:42px;height:42px;border-radius:999px;background:conic-gradient(from 140deg,#38bdf8,#a855f7,#f97316,#22c55e);display:flex;align-items:center;justify-content:center;color:#020617;font-weight:700">C</div>
        <div>
          <div style="font-weight:600">Curtis</div>
          <div style="font-size:12px;color:var(--text-sub)">Local account</div>
        </div>
      </div>

      <div style="margin-top:12px;">
        <div style="margin-bottom:6px;">Account name</div>
        <input id="accName" type="text" value="Curtis" style="width:220px;padding:6px;border-radius:6px;border:1px solid rgba(75,85,99,.9);background:rgba(15,23,42,.95);color:var(--text-main)">
      </div>

      <div style="margin-top:12px;">
        <div style="margin-bottom:6px;">Require password on unlock</div>
        <div style="display:flex;align-items:center;gap:8px">
          <div class="settings-toggle" id="accPwOnUnlock"><div class="settings-toggle-knob"></div></div>
          <div style="font-size:13px;color:var(--text-sub)">When enabled, lockscreen requires password</div>
        </div>
      </div>

      <div style="margin-top:12px;">
        <div style="margin-bottom:6px;">Password</div>
        <input id="accPasswordInput" type="password" placeholder="Set password" style="width:220px;padding:6px;border-radius:6px;border:1px solid rgba(75,85,99,.9);background:rgba(15,23,42,.95);color:var(--text-main)">
        <button class="theme-btn" id="accSavePassword" style="margin-left:8px">Save</button>
      </div>
    </div>
  `;
  const toggle = panel.querySelector("#accPwOnUnlock");
  function updateToggle(){ toggle.classList.toggle("on", OS.state.passwordEnabled); }
  toggle.onclick = ()=>{
    OS.state.passwordEnabled = !OS.state.passwordEnabled;
    try{ localStorage.setItem("lp-password-enabled", OS.state.passwordEnabled ? "1" : "0"); }catch(e){}
    updateToggle();
    showToast("Password requirement toggled.");
  };
  updateToggle();
  const pwInput = panel.querySelector("#accPasswordInput");
  panel.querySelector("#accSavePassword").onclick = ()=>{
    const v = pwInput.value.trim();
    if(!v){
      OS.state.passwordHash = null;
      try{ localStorage.removeItem("lp-password-hash"); }catch(e){}
      showToast("Password cleared.");
      return;
    }
    const h = simpleHash(v);
    OS.state.passwordHash = h;
    try{ localStorage.setItem("lp-password-hash", h); }catch(e){}
    showToast("Password saved.");
  };
}

/* Glass panel (persisted) */
function renderGlassPanel(panel){
  const currentPercent = Math.round((OS.config.glassLevel || 0.8) * 100);
  panel.innerHTML = `
    <h2>Glass</h2>
    <div class="settings-section">
      <div class="setting-group-title">Transparency presets</div>
      <div class="setting-options">
        <button class="settings-radio-btn" data-preset="glassy">Glassy</button>
        <button class="settings-radio-btn" data-preset="balanced">Balanced</button>
        <button class="settings-radio-btn" data-preset="solid">Solid</button>
      </div>
    </div>
    <div class="settings-section">
      <div class="setting-group-title">Custom level</div>
      <input type="range" min="0" max="100" value="${currentPercent}" class="glass-slider">
      <div style="font-size:12px;color:var(--text-sub);margin-top:6px;">Affects taskbar, icons, start menu, folders, context menus, notifications.</div>
    </div>
  `;
  const slider = panel.querySelector(".glass-slider");
  function applyGlass(level){
    const t = Math.max(0.05, Math.min(1, level/100));
    document.documentElement.style.setProperty("--glass-opacity", String(t));
    document.documentElement.style.setProperty("--glass-border-alpha", String(0.3 + 0.4*t));
    document.documentElement.style.setProperty("--icon-glass-opacity", String(0.5 + 0.5*t));
    OS.config.glassLevel = t;
    try{ localStorage.setItem("lp-glass", String(t)); }catch(e){}
    renderTaskbar();
    const panels = [$("#startMenu .inner"), $("#notifPanel .inner"), $("#ctxMenu .inner")];
    panels.forEach(p=>{ if(p) p.style.background = `rgba(15,23,42,${t})`; });
  }
  slider.oninput = ()=>{ applyGlass(Number(slider.value)); updatePresetActive(Number(slider.value)); };
  function updatePresetActive(v){
    panel.querySelectorAll(".settings-radio-btn[data-preset]").forEach(b=>b.classList.remove("active"));
    if(Math.abs(v-80)<=6) panel.querySelector('[data-preset="glassy"]').classList.add("active");
    else if(Math.abs(v-50)<=6) panel.querySelector('[data-preset="balanced"]').classList.add("active");
    else if(Math.abs(v-20)<=6) panel.querySelector('[data-preset="solid"]').classList.add("active");
  }
  panel.querySelectorAll(".settings-radio-btn[data-preset]").forEach(btn=>{
    btn.onclick = ()=>{
      const p = btn.dataset.preset;
      let v = 80; if(p==="balanced") v=50; if(p==="solid") v=20;
      slider.value = v; applyGlass(v); panel.querySelectorAll(".settings-radio-btn[data-preset]").forEach(x=>x.classList.remove("active")); btn.classList.add("active");
    };
  });
  slider.value = currentPercent; applyGlass(currentPercent); updatePresetActive(currentPercent);
}

/* -------------------------
   Notes, Calculator, This PC, Recycle, Terminal, Task Manager
   (register core apps with full content)
   ------------------------- */
registerApp("notes", {
  title: "Notes",
  createContent(){ const d=document.createElement("div"); d.innerHTML=`<textarea style="width:100%;height:100%;padding:8px;border-radius:8px;border:1px solid rgba(55,65,81,.9);background:rgba(15,23,42,.95);color:var(--text-main)">${localStorage.getItem("lp-notes")||""}</textarea>`; const ta=d.querySelector("textarea"); ta.oninput=()=>localStorage.setItem("lp-notes", ta.value); return d; }
});
registerApp("calculator", {
  title: "Calculator",
  createContent(){ const d=document.createElement("div"); d.innerHTML=`<div style="font-size:13px">Calculator (basic)</div>`; return d; }
});
registerApp("thispc", {
  title: "This PC",
  createContent(){ const d=document.createElement("div"); d.innerHTML=`<div style="font-size:13px">This PC - virtual info</div>`; return d; }
});
registerApp("recycle-bin", {
  title: "Recycle Bin",
  createContent(){ const root=document.createElement("div"); root.innerHTML=`<div style="font-size:13px">Recycle Bin</div><div id="rbList" style="margin-top:8px"></div>`; renderRecycleBinList(); return root; }
});
registerApp("terminal", {
  title: "Terminal",
  createContent(){ const d=document.createElement("pre"); d.style.fontFamily="monospace"; d.style.fontSize="12px"; d.style.background="#020617"; d.style.padding="8px"; d.style.borderRadius="8px"; d.style.height="100%"; d.textContent = "Liquid Plastic Shell 1.x\n\n> help\n"; return d; }
});
registerApp("taskmgr", {
  title: "Task Manager",
  createContent(){ const root=document.createElement("div"); root.innerHTML=`<div style="font-size:13px">Task Manager</div><div id="taskList" style="margin-top:8px"></div>`; renderTaskManagerContent(root); return root; }
});

/* Recycle helpers */
function moveToRecycleBin(icon){
  OS.state.recycleBin.push({ name: icon.name, appId: icon.appId, time: new Date() });
}
function renderRecycleBinList(){
  const list = $("#rbList");
  if(!list) return;
  list.innerHTML = "";
  if(OS.state.recycleBin.length===0){ list.innerHTML = `<div style="color:var(--text-sub)">Recycle Bin is empty.</div>`; return; }
  OS.state.recycleBin.forEach((it, idx)=>{
    const row = document.createElement("div"); row.style.display="flex"; row.style.justifyContent="space-between"; row.style.padding="6px 0";
    row.innerHTML = `<div>${escapeHtml(it.name)}</div><div style="display:flex;gap:6px"><button data-restore="${idx}">Restore</button><button data-delete="${idx}">Delete</button></div>`;
    row.querySelector("[data-restore]").onclick = ()=>{
      const item = OS.state.recycleBin[idx];
      OS.state.desktopIcons.push({ id:"restored-"+Date.now(), name:item.name, appId:item.appId, x:120, y:40, selected:false, type:"shortcut" });
      OS.state.recycleBin.splice(idx,1); renderRecycleBinList(); renderDesktopIcons();
    };
    row.querySelector("[data-delete]").onclick = ()=>{ OS.state.recycleBin.splice(idx,1); renderRecycleBinList(); };
    list.appendChild(row);
  });
}

/* Task Manager content */
function renderTaskManagerContent(root){
  const rows = OS.state.windows.map(w=>{ const id=w.dataset.appId; const app=OS.state.apps[id]; return `<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid rgba(55,65,81,.9)"><div>${escapeHtml(app?app.title:id)}</div><div><button data-kill="${id}">End task</button></div></div>`; }).join("");
  const container = root.querySelector("#taskList");
  if(container) container.innerHTML = rows || `<div style="color:var(--text-sub)">No running apps.</div>`;
  root.querySelectorAll("[data-kill]").forEach(btn=> btn.onclick = ()=>{
    const id = btn.dataset.kill;
    const win = OS.state.windows.find(w=>w.dataset.appId===id);
    if(win){ win.remove(); OS.state.windows = OS.state.windows.filter(w=>w!==win); if(OS.state.activeWindow===win) OS.state.activeWindow=null; renderTaskbar(); renderTaskManagerContent(root); }
  });
}

/* -------------------------
   Store with delayed install UI + more apps (including LP Music iframe)
   ------------------------- */
const storeCatalog = [
  { id:"paint", title:"Liquid Paint", desc:"Simple drawing app (concept)." },
  { id:"music", title:"LP Music", desc:"Music player (YT Music / Spotify iframe option)." },
  { id:"notes", title:"Notes", desc:"Simple notes app." },
  { id:"calc", title:"Calculator", desc:"Basic calculator." },
  { id:"browser", title:"LP Browser", desc:"Lightweight LP browser." }
];

registerApp("store", {
  title: "Store",
  createContent(){
    const root = document.createElement("div");
    root.className = "store-app";
    root.innerHTML = `<h2>Store</h2><div class="store-grid" id="storeGrid"></div>`;
    renderStoreGrid(root.querySelector("#storeGrid"));
    return root;
  }
});

function renderStoreGrid(container){
  container.innerHTML = storeCatalog.map(item=>{
    const installed = !!OS.state.apps[item.id];
    return `<div class="store-card" data-id="${item.id}">
      <div style="font-weight:600">${escapeHtml(item.title)}</div>
      <div style="color:var(--text-sub);margin-top:6px">${escapeHtml(item.desc)}</div>
      <div style="margin-top:8px;display:flex;gap:8px">
        <button class="theme-btn store-install" data-install="${item.id}">${installed ? "Installed" : "Install"}</button>
        <button class="theme-btn store-uninstall" data-uninstall="${item.id}">Uninstall</button>
      </div>
    </div>`;
  }).join("");
  container.querySelectorAll(".store-install").forEach(btn=>{
    btn.onclick = ()=>{
      const id = btn.dataset.install;
      if(OS.state.apps[id]){ showToast("Already installed."); return; }
      btn.textContent = "Installing..."; btn.disabled = true;
      // simulate install delay and UI state
      setTimeout(()=>{
        performInstall(id);
        renderStoreGrid(container);
      }, 900);
    };
  });
  container.querySelectorAll(".store-uninstall").forEach(btn=>{
    btn.onclick = ()=>{
      const id = btn.dataset.uninstall;
      if(!OS.state.apps[id]){ showToast("Not installed."); return; }
      performUninstall(id);
      renderStoreGrid(container);
    };
  });
}

function performInstall(id){
  // register apps with functional content if not present
  if(id==="paint" && !OS.state.apps["paint"]){
    registerApp("paint",{ title:"Liquid Paint", createContent(){ const d=document.createElement("div"); d.innerHTML=`<div style="font-size:13px">Liquid Paint (concept canvas)</div>`; return d; }});
  }
  if(id==="music" && !OS.state.apps["music"]){
    registerApp("music",{ title:"LP Music", createContent(){
      const d=document.createElement("div");
      d.style.height="100%";
      d.innerHTML = `
        <div style="display:flex;flex-direction:column;height:100%;gap:8px">
          <div style="display:flex;gap:8px;align-items:center">
            <label style="font-size:13px">Source</label>
            <select id="lpMusicSource" style="padding:6px;border-radius:6px;background:rgba(15,23,42,.95);color:var(--text-main)">
              <option value="https://music.youtube.com">YouTube Music</option>
              <option value="https://open.spotify.com">Spotify</option>
            </select>
            <button id="lpMusicLoad" class="theme-btn">Load</button>
          </div>
          <div style="flex:1;border-radius:8px;overflow:hidden;border:1px solid rgba(55,65,81,.9)">
            <iframe id="lpMusicFrame" src="https://music.youtube.com" style="width:100%;height:100%;border:0"></iframe>
          </div>
        </div>
      `;
      setTimeout(()=>{
        const sel = d.querySelector("#lpMusicSource");
        const btn = d.querySelector("#lpMusicLoad");
        const frame = d.querySelector("#lpMusicFrame");
        btn.onclick = ()=>{ frame.src = sel.value; };
      },10);
      return d;
    }});
  }
  if(id==="notes" && !OS.state.apps["notes"]){
    registerApp("notes",{ title:"Notes", createContent(){ const d=document.createElement("div"); d.innerHTML=`<textarea style="width:100%;height:100%;padding:8px;border-radius:8px;background:rgba(15,23,42,.95);color:var(--text-main)"></textarea>`; return d; }});
  }
  if(id==="calc" && !OS.state.apps["calc"]){
    registerApp("calc",{ title:"Calculator", createContent(){ const d=document.createElement("div"); d.innerHTML=`<div style="font-size:13px">Calculator</div>`; return d; }});
  }
  if(id==="browser" && !OS.state.apps["browser"]){
    registerApp("browser",{ title:"LP Browser", createContent(){ const d=document.createElement("div"); d.innerHTML=`<div style="font-size:13px">LP Browser</div>`; return d; }});
  }

  // after a short delay add to pinned apps so Start shows it
  setTimeout(()=>{
    if(!pinnedApps.includes(id)) pinnedApps.push(id);
    notify("Store", `Installed ${id} and added to Start.`);
    showToast(`Installed ${id}`);
    if(OS.state.startMenuOpen) renderStartMenuContent();
  }, 350);
}

function performUninstall(id){
  if(!OS.state.apps[id]){ showToast("Not installed."); return; }
  OS.state.windows.forEach(w=>{ if(w.dataset.appId===id) w.remove(); });
  OS.state.windows = OS.state.windows.filter(w=>w.dataset.appId!==id);
  delete OS.state.apps[id];
  pinnedApps = pinnedApps.filter(p=>p!==id);
  OS.state.desktopIcons = OS.state.desktopIcons.filter(i=>i.appId!==id);
  renderDesktopIcons(); renderTaskbar();
  notify("Store", `Uninstalled ${id}.`);
  showToast(`Uninstalled ${id}`);
  if(OS.state.startMenuOpen) renderStartMenuContent();
}

/* -------------------------
   Notifications
   ------------------------- */
function renderNotifications(){
  const panel = $("#notifPanel .inner");
  if(!panel) return;
  panel.innerHTML = "";
  const tools = document.createElement("div"); tools.style.display="flex"; tools.style.justifyContent="space-between"; tools.style.marginBottom="6px"; tools.innerHTML = `<div>Notifications</div><div style="cursor:pointer;color:var(--accent)" id="notifClear">Clear</div>`;
  panel.appendChild(tools);
  const list = document.createElement("div");
  if(OS.state.notifications.length===0) list.innerHTML = `<div style="color:var(--text-sub)">No notifications.</div>`;
  else OS.state.notifications.forEach(n=>{
    const item = document.createElement("div"); item.className="notif"; item.style.marginBottom="6px"; item.innerHTML = `<div style="font-weight:600">${escapeHtml(n.title)}</div><div style="font-size:13px">${escapeHtml(n.message)}</div><div style="font-size:12px;color:var(--text-sub)">${n.time.toLocaleTimeString()}</div>`;
    list.appendChild(item);
  });
  panel.appendChild(list);
  $("#notifClear").onclick = ()=>{ OS.state.notifications = []; renderNotifications(); };
}
function toggleNotifPanel(force){
  const p = $("#notifPanel");
  if(typeof force === "boolean") OS.state.notifOpen = force;
  else OS.state.notifOpen = !OS.state.notifOpen;
  if(OS.state.notifOpen){ renderNotifications(); p.style.display = "block"; } else p.style.display = "none";
}

/* -------------------------
   Start menu & pinned apps
   ------------------------- */
let pinnedApps = ["browser","settings","notes","store","terminal","calculator","thispc","recycle-bin"];
let currentDraggedAppId = null;

function renderStartMenuContent(){
  const inner = $("#startMenu .inner");
  if(!inner) return;
  inner.innerHTML = `
    <div class="start-header">
      <div class="start-account" id="startAccountBtn">
        <div style="width:28px;height:28px;border-radius:999px;background:conic-gradient(from 140deg,#38bdf8,#a855f7,#f97316,#22c55e);display:flex;align-items:center;justify-content:center;color:#020617;font-weight:700">C</div>
        <div style="display:flex;flex-direction:column">
          <div style="font-weight:600">Curtis</div>
          <div style="font-size:12px;color:var(--text-sub)">Local account</div>
        </div>
      </div>
      <div style="align-self:flex-end"><button id="btnTaskMgr">Task Manager</button></div>
    </div>
    <div class="start-grid" id="startGrid"></div>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:10px">
      <button id="startLock">Lock</button>
      <button id="startSignOut">Sign out</button>
      <button id="startShutdown">Shut down</button>
    </div>
  `;
  const grid = $("#startGrid");
  grid.innerHTML = "";
  pinnedApps.forEach(id=>{
    const app = OS.state.apps[id];
    if(!app) return;
    const tile = document.createElement("div"); tile.className="start-tile"; tile.dataset.appId = id;
    tile.innerHTML = `<div style="width:36px;height:36px;border-radius:8px;background:conic-gradient(from 220deg,#38bdf8,#22c55e,#f97316)"></div><div style="margin-top:6px;font-size:13px">${escapeHtml(app.title)}</div>`;
    tile.onclick = (e)=>{ if(e.ctrlKey||e.metaKey) return; openApp(id); toggleStartMenu(false); };
    tile.draggable = true;
    tile.addEventListener("dragstart",(e)=>{ currentDraggedAppId = id; e.dataTransfer.effectAllowed = "copy"; });
    grid.appendChild(tile);
  });

  $("#startAccountBtn").onclick = ()=>{
    const win = openApp("settings");
    if(!win) return;
    setTimeout(()=>{ const item = [...$$(".settings-item", win)].find(el=>el.dataset.panel==="account"); if(item) item.click(); }, 10);
  };
  $("#btnTaskMgr").onclick = ()=>openApp("taskmgr");
  $("#startLock").onclick = ()=>{ minimizeAllWindows(); toggleStartMenu(false); showLockscreen(false); };
  $("#startSignOut").onclick = ()=>{ minimizeAllWindows(); toggleStartMenu(false); showLockscreen(false); };
  $("#startShutdown").onclick = ()=>{ minimizeAllWindows(); toggleStartMenu(false); notify("System","Shutdown simulated."); showToast("Shutdown simulated."); };
}
function toggleStartMenu(force){
  const m = $("#startMenu");
  if(typeof force === "boolean") OS.state.startMenuOpen = force;
  else OS.state.startMenuOpen = !OS.state.startMenuOpen;
  if(OS.state.startMenuOpen){ renderStartMenuContent(); m.style.display = "block"; } else m.style.display = "none";
}
function togglePinStart(appId){
  if(!appId) return;
  if(pinnedApps.includes(appId)){ pinnedApps = pinnedApps.filter(a=>a!==appId); notify("Start","App unpinned."); }
  else { pinnedApps.push(appId); notify("Start","App pinned."); }
  if(OS.state.startMenuOpen) renderStartMenuContent();
}

/* Drag from Start to Desktop */
const desktopEl = document.querySelector(".desktop");
if(desktopEl){
  desktopEl.addEventListener("dragover",(e)=>{ if(currentDraggedAppId) e.preventDefault(); });
  desktopEl.addEventListener("drop",(e)=>{
    if(!currentDraggedAppId) return;
    e.preventDefault();
    const rect = desktopEl.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    const app = OS.state.apps[currentDraggedAppId];
    OS.state.desktopIcons.push({ id:"shortcut-"+Date.now(), name: app?app.title:currentDraggedAppId, appId: currentDraggedAppId, x: x-30, y: y-30, selected:false, type:"shortcut" });
    currentDraggedAppId = null;
    renderDesktopIcons();
  });
}

/* -------------------------
   Taskbar rendering & clock
   ------------------------- */
function renderTaskbar(){
  const bar = $("#taskbar");
  if(!bar) return;
  bar.innerHTML = "";
  const left = document.createElement("div"); left.className="task-left"; left.innerHTML = `<button class="task-btn" id="btnStart">Start</button>`;
  const mid = document.createElement("div"); mid.className="task-mid taskbar-apps";
  OS.state.windows.forEach(win=>{
    const appId = win.dataset.appId; const app = OS.state.apps[appId];
    const btn = document.createElement("div"); btn.className="tb-app"; if(win.style.display!=="none") btn.classList.add("active");
    btn.dataset.appId = appId; btn.textContent = app?app.title:appId;
    btn.onclick = ()=>{ if(win.style.display==="none"){ win.style.display="flex"; focusWindow(win); } else if(OS.state.activeWindow===win){ win.style.display="none"; } else focusWindow(win); renderTaskbar(); };
    mid.appendChild(btn);
  });
  const right = document.createElement("div"); right.className="task-right"; right.style.gap="8px";
  const clock = document.createElement("div"); clock.style.textAlign="right"; clock.innerHTML = `<div id="tbTime" style="font-size:13px">--:--</div><div style="font-size:11px;color:var(--text-sub)" id="tbDate">--/--/----</div>`;
  const notifBtn = document.createElement("button"); notifBtn.className="task-btn"; notifBtn.id="btnNotif"; notifBtn.textContent = "Notifications";
  right.appendChild(clock); right.appendChild(notifBtn);
  bar.appendChild(left); bar.appendChild(mid); bar.appendChild(right);

  $("#btnStart").onclick = (e)=>{ e.stopPropagation(); toggleStartMenu(); };
  $("#btnNotif").onclick = (e)=>{ e.stopPropagation(); toggleNotifPanel(); };
  updateClock();
}
function updateClock(){
  if(!OS.state.bootDone) return;
  const now = new Date(); const use24 = OS.config.clock24;
  const h24 = now.getHours(); const h = use24 ? String(h24).padStart(2,"0") : (h24%12||12);
  const m = String(now.getMinutes()).padStart(2,"0");
  const t = $("#tbTime"); const d = $("#tbDate");
  if(t) t.textContent = use24 ? `${h}:${m}` : `${h}:${m} ${h24>=12?"PM":"AM"}`;
  if(d) d.textContent = `${now.getMonth()+1}/${now.getDate()}/${now.getFullYear()}`;
}
setInterval(updateClock,30000);

/* -------------------------
   Context menu global close (ignore clicks inside ctxMenu)
   ------------------------- */
document.addEventListener("mousedown",(e)=>{
  if(!e.target.closest("#startMenu") && !e.target.closest("#taskbar")) toggleStartMenu(false);
  if(!e.target.closest("#notifPanel") && !e.target.closest("#taskbar")) toggleNotifPanel(false);
  if(!e.target.closest("#ctxMenu")) $("#ctxMenu").style.display = "none";
});

/* right-click handling for taskbar items */
document.addEventListener("contextmenu",(e)=>{
  const iconEl = e.target.closest(".icon");
  if(iconEl) return; // desktop icons handled separately
  const tbBtn = e.target.closest(".tb-app");
  const tb = e.target.closest("#taskbar");
  const startBtn = e.target.closest("#btnStart");
  const startMenuEl = e.target.closest("#startMenu");
  if(tbBtn){ e.preventDefault(); showTaskbarAppContextMenu(tbBtn, e.clientX, e.clientY); return; }
  if(startBtn){ e.preventDefault(); showSimpleContextMenu("Start menu settings (placeholder)", e.clientX, e.clientY); return; }
  if(tb && !tbBtn){ e.preventDefault(); showSimpleContextMenu("Taskbar settings (placeholder)", e.clientX, e.clientY); return; }
  if(startMenuEl){ e.preventDefault(); showSimpleContextMenu("Start menu settings (placeholder)", e.clientX, e.clientY); return; }
});
function showSimpleContextMenu(label,x,y){
  const menu = $("#ctxMenu"); const inner = menu.querySelector(".inner");
  inner.innerHTML = `<div class="ctx-item">${escapeHtml(label)}</div>`;
  menu.style.left = x + "px"; menu.style.top = y + "px"; menu.style.display = "block";
}
function showTaskbarAppContextMenu(tbBtn,x,y){
  const appId = tbBtn.dataset.appId; const win = OS.state.windows.find(w=>w.dataset.appId===appId);
  if(!win) return;
  const menu = $("#ctxMenu"); const inner = menu.querySelector(".inner");
  inner.innerHTML = `<div class="ctx-item" data-act="close">Close</div>`;
  menu.style.left = x + "px"; menu.style.top = y + "px"; menu.style.display = "block";
  inner.querySelector("[data-act='close']").onclick = ()=>{
    win.remove(); OS.state.windows = OS.state.windows.filter(w=>w!==win); if(OS.state.activeWindow===win) OS.state.activeWindow=null; renderTaskbar(); menu.style.display="none";
  };
}

/* -------------------------
   Init desktop
   ------------------------- */
function initDesktop(){
  seedDesktopIcons();
  renderDesktopIcons();
  enableSelectionBox();
  enableIconDragging();
  renderTaskbar();
  OS.state.bootDone = true;
  // apply glass
  const g = OS.config.glassLevel;
  document.documentElement.style.setProperty("--glass-opacity", String(g));
  document.documentElement.style.setProperty("--glass-border-alpha", String(0.3 + 0.4*g));
  document.documentElement.style.setProperty("--icon-glass-opacity", String(0.5 + 0.5*g));
}

/* -------------------------
   Helpers
   ------------------------- */
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }

/* -------------------------
   DOM ready -> boot
   ------------------------- */
document.addEventListener("DOMContentLoaded", startBoot);

/* -------------------------
   Ensure core apps exist (no placeholders)
   ------------------------- */
(function ensureCore(){
  const core = ["settings","store","thispc","terminal","notes","calculator","browser","recycle-bin","taskmgr"];
  core.forEach(id=>{ if(!OS.state.apps[id]){ /* no-op: apps registered above; if missing, user can reinstall from Store */ } });
})();

</script>
</body>
</html>
