<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Liquid Plastic OS 1.x</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
:root{
  --accent:#4aa8ff;
  --bg-gradient:radial-gradient(circle at top,#182235 0%,#050711 55%,#020308 100%);
  --text-main:#f9fafb;
  --text-sub:#9ca3af;

  --glass-opacity:0.80;
  --glass-border-alpha:0.50;
  --icon-glass-opacity:0.80;

  --radius:18px;
}

/* Global */
*{box-sizing:border-box;margin:0;padding:0}
body{
  margin:0;
  font-family:system-ui,-apple-system,BlinkMacSystemFont,"SF Pro Text",sans-serif;
  background:var(--bg-gradient);
  color:var(--text-main);
  overflow:hidden;
}

/* Neon hover glow for all primary buttons */
button,
.task-btn,
.theme-btn,
.settings-wall-btn,
.settings-accent-btn,
.settings-radio-btn,
.start-tile,
.tb-app,
.win-btn,
.start-account {
  transition: box-shadow .15s, background .15s, border-color .15s, transform .08s;
}
button:hover,
.task-btn:hover,
.theme-btn:hover,
.settings-wall-btn:hover,
.settings-accent-btn:hover,
.settings-radio-btn:hover,
.start-tile:hover,
.tb-app:hover,
.win-btn:hover,
.start-account:hover {
  box-shadow:0 0 18px rgba(59,130,246,0.95);
  border-color:var(--accent);
  background:rgba(37,99,235,0.12);
  transform:translateY(-1px);
}

/* Glass helpers */
.glass-ui{
  background:rgba(15,23,42,var(--glass-opacity));
  border-radius:var(--radius);
  border:1px solid rgba(148,163,184,var(--glass-border-alpha));
  backdrop-filter:blur(20px) saturate(180%);
  -webkit-backdrop-filter:blur(20px) saturate(180%);
  box-shadow:0 18px 50px rgba(0,0,0,.80);
}
.glass-win{
  position:absolute;
  background:rgba(15,23,42,0.88);
  border-radius:var(--radius);
  border:1px solid rgba(148,163,184,0.55);
  backdrop-filter:blur(22px) saturate(180%);
  -webkit-backdrop-filter:blur(22px) saturate(180%);
  box-shadow:0 22px 60px rgba(0,0,0,.80);
}

/* BIOS */
#bios{
  position:fixed;inset:0;background:#020617;color:#e5e7eb;font-family:monospace;
  font-size:12px;padding:20px;z-index:1500;display:flex;flex-direction:column;
}
#bios-title{font-size:16px;margin-bottom:2px}
#bios-bar{
  width:260px;height:6px;border-radius:999px;background:#020617;
  box-shadow:0 0 12px rgba(0,0,0,.8);overflow:hidden;margin-top:16px;
}
#bios-bar-inner{
  height:100%;width:0;background:linear-gradient(90deg,#4aa8ff,#22c55e);
  transition:width .15s linear;
}
#bios .hint{margin-top:14px;color:#9ca3af}

/* Desktop */
.desktop{
  position:fixed;inset:0;
  background:var(--bg-gradient);
  overflow:hidden;
}
.glow{
  position:absolute;border-radius:999px;filter:blur(60px);opacity:.6;mix-blend-mode:screen;
}
.g1{width:40vw;height:40vw;background:radial-gradient(circle,#38bdf8,transparent 60%);top:-10%;left:-10%}
.g2{width:32vw;height:32vw;background:radial-gradient(circle,#fb7185,transparent 60%);bottom:-12%;right:-5%}
.g3{width:26vw;height:26vw;background:radial-gradient(circle,#5eead4,transparent 60%);bottom:10%;left:15%}

/* Lockscreen */
#lockscreen{
  position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
  z-index:1000;backdrop-filter:blur(26px);-webkit-backdrop-filter:blur(26px);
  pointer-events:none;opacity:0;transition:opacity .25s;
}
#lockscreen.visible{pointer-events:auto;opacity:1;}
.lock-panel{width:420px;padding:32px;text-align:center}
.lock-panel-inner{
  border-radius:26px;border:1px solid rgba(148,163,184,.6);
  background:rgba(15,23,42,.92);backdrop-filter:blur(24px);padding:24px;
}
.lock-time{font-size:64px;font-weight:600}
.lock-date{margin-top:4px;font-size:16px;color:var(--text-sub)}
.account-pill{
  display:flex;align-items:center;gap:10px;margin-top:24px;padding:10px 16px;
  border-radius:999px;background:rgba(15,23,42,.88);border:1px solid rgba(255,255,255,.25);cursor:pointer;
}
.avatar{
  width:34px;height:34px;border-radius:999px;background:conic-gradient(from 140deg,#38bdf8,#a855f7,#f97316,#22c55e);
  display:flex;align-items:center;justify-content:center;color:#020617;font-weight:700;font-size:16px;
}
.lock-user{font-size:14px;text-align:left}
.lock-user-sub{font-size:12px;color:var(--text-sub)}
#lockHint{margin-top:10px;font-size:12px;color:var(--text-sub)}

/* Desktop icons */
#desktopIcons{position:fixed;inset:0;padding:8px;pointer-events:auto}
.icon{
  position:absolute;width:76px;text-align:center;font-size:11px;pointer-events:auto;cursor:pointer;
  user-select:none;
}
.icon-body{
  width:46px;height:46px;margin:0 auto 4px;border-radius:18px;
  background:conic-gradient(from 210deg,#38bdf8,#22c55e,#f97316,#ec4899);
  position:relative;overflow:hidden;box-shadow:0 12px 26px rgba(0,0,0,.7);
}
.icon-body::after{
  content:"";position:absolute;inset:2px;border-radius:inherit;
  background:rgba(15,23,42,var(--icon-glass-opacity));
}
.icon-label{color:var(--text-main);}
.icon.selected .icon-body{outline:2px solid var(--accent)}
.icon.folder .icon-body{
  border-radius:18px;
  background:rgba(15,23,42,0.85);
  border:1px solid rgba(148,163,184,0.6);
}
.folder-grid-preview{
  position:absolute;inset:6px;display:grid;grid-template-columns:repeat(2,1fr);grid-template-rows:repeat(2,1fr);gap:2px;
}
.folder-grid-preview div{
  border-radius:6px;
  background:conic-gradient(from 220deg,#38bdf8,#22c55e,#f97316,#ec4899);
}

/* Selection box */
#selectBox{
  position:fixed;border:1px solid rgba(148,163,184,.8);background:rgba(59,130,246,0.18);
  display:none;pointer-events:none;z-index:50;
}

/* Context menu */
#ctxMenu{
  position:fixed;min-width:160px;display:none;z-index:1200;font-size:12px;
}
#ctxMenu .inner{padding:4px 0;border-radius:10px;}
.ctx-item{padding:6px 10px;color:var(--text-main);cursor:pointer;white-space:nowrap;}
.ctx-item:hover{background:var(--accent);color:#020617}

/* Taskbar – flat, not pill */
#taskbar{
  position:fixed;left:0;right:0;bottom:0;height:46px;
  padding:6px 10px 4px; /* slight top padding to avoid clipping outlines */
  display:flex;align-items:center;gap:8px;z-index:800;
  background:rgba(15,23,42,var(--glass-opacity));
  border-top:1px solid rgba(148,163,184,var(--glass-border-alpha));
  backdrop-filter:blur(20px) saturate(180%);
  -webkit-backdrop-filter:blur(20px) saturate(180%);
  border-radius:0;
  overflow:visible; /* ensure glow/outline not clipped */
}
.task-left,.task-mid,.task-right{display:flex;align-items:center}
.task-mid{flex:1;justify-content:center}
.task-btn{
  border-radius:999px;border:1px solid rgba(148,163,184,.5);
  padding:6px 12px;background:rgba(15,23,42,.94);color:var(--text-main);
  font-size:12px;cursor:pointer;display:inline-flex;align-items:center;gap:6px;
}
.task-clock{text-align:right;font-size:12px;margin-right:8px}
.task-clock .date{font-size:11px;color:var(--text-sub)}
.taskbar-apps{display:flex;gap:4px;align-items:center;overflow:visible}
.tb-app{
  border-radius:999px;padding:4px 10px;border:1px solid transparent;
  background:rgba(15,23,42,.90);font-size:11px;display:flex;align-items:center;gap:4px;cursor:pointer;
}
.tb-app.active{
  box-shadow:0 0 0 2px rgba(74,168,255,0.18), 0 0 12px rgba(74,168,255,0.18);
  border-color:rgba(74,168,255,0.6);
}

/* Start menu */
#startMenu{
  position:fixed;left:10px;bottom:58px;width:360px;max-height:460px;display:none;z-index:850;
}
#startMenu .inner{padding:10px;border-radius:18px;}
.start-header{display:flex;justify-content:space-between;align-items:flex-start;font-size:12px;color:var(--text-sub);margin-bottom:6px;}
.start-account{
  display:flex;align-items:center;gap:8px;
  padding:6px 10px;border-radius:18px;
  background:rgba(15,23,42,0.9);border:1px solid rgba(148,163,184,0.7);
  cursor:pointer;
}
.start-account:hover{box-shadow:0 0 18px rgba(59,130,246,0.95);} /* neon glow on hover */
.start-account-avatar{
  width:26px;height:26px;border-radius:999px;
  background:conic-gradient(from 140deg,#38bdf8,#a855f7,#f97316,#22c55e);
  display:flex;align-items:center;justify-content:center;font-size:14px;color:#020617;font-weight:600;
}
.start-account-text{display:flex;flex-direction:column;line-height:1.15;}
.start-account-name{font-size:12px;color:var(--text-main);}
.start-account-sub{font-size:11px;color:var(--text-sub);}
.start-header-right{align-self:flex-end;font-size:11px;}
.start-header-right button{
  border-radius:999px;border:1px solid rgba(148,163,184,.5);
  padding:4px 10px;background:rgba(15,23,42,0.94);color:var(--text-main);
  font-size:11px;cursor:pointer;
}
.start-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-top:10px}
.start-tile{
  border-radius:16px;padding:6px 4px;text-align:center;font-size:11px;
  background:rgba(15,23,42,.9);border:1px solid rgba(148,163,184,.5);
  color:var(--text-main);cursor:pointer;display:flex;flex-direction:column;gap:4px;align-items:center;
}
.start-icon{
  width:26px;height:26px;border-radius:999px;
  background:conic-gradient(from 220deg,#38bdf8,#22c55e,#f97316,#ec4899);
}
.start-footer{display:flex;justify-content:flex-end;gap:6px;margin-top:8px;font-size:11px}
.start-footer button{
  border-radius:999px;border:1px solid rgba(148,163,184,.5);
  padding:4px 10px;background:rgba(15,23,42,0.94);color:var(--text-main);
  font-size:11px;cursor:pointer;
}

/* Notifications panel */
#notifPanel{
  position:fixed;right:10px;bottom:58px;width:260px;max-height:320px;display:none;z-index:850;font-size:12px;
}
#notifPanel .inner{padding:8px;border-radius:14px;}
.notif-list{max-height:260px;overflow:auto}
.notif{
  border-radius:10px;padding:6px 8px;margin-bottom:4px;
  background:rgba(15,23,42,.9);border:1px solid rgba(148,163,184,.6);position:relative;
}
.notif-title{font-weight:600}
.notif-time{font-size:11px;color:var(--text-sub)}
.notif-close{position:absolute;right:6px;top:4px;font-size:11px;cursor:pointer;color:var(--text-sub)}

/* Windows */
.window{
  position:absolute;min-width:380px;min-height:230px;display:none;flex-direction:column;
  border-radius:var(--radius);overflow:hidden;z-index:500;
  transition:opacity .18s ease-out, transform .18s ease-out;
}
.window.hidden{opacity:0;transform:scale(0.96);}
.window.visible{opacity=1;transform:scale(1);}
.window.dragging{transition:none !important;}
.win-header{
  display:flex;align-items:center;padding:6px 10px;gap:8px;
  border-bottom:1px solid rgba(148,163,184,.3);cursor:move;
}
.win-title{font-size:12px;color:var(--text-sub)}
.win-controls{margin-left:auto;display:flex;gap:4px}
.win-btn{
  width:24px;height:18px;border-radius:4px;border:1px solid rgba(148,163,184,.5);
  background:rgba(15,23,42,.9);color:var(--text-main);font-size:12px;cursor:pointer;
}
.win-btn[data-close]:hover{background:#E81123;border-color:#E81123;color:#fff;}
.win-body{flex:1;padding:8px 10px;font-size:13px;overflow:auto}
.window-resize-handle{
  position:absolute;
  right:4px;
  bottom:4px;
  width:12px;
  height:12px;
  cursor:nwse-resize;
  border-radius:3px;
  background:linear-gradient(135deg,rgba(148,163,184,0.4),transparent);
}

/* Browser */
.browser-app{display:flex;flex-direction:column;height:100%}
.browser-bar{display:flex;align-items:center;gap:4px;margin-bottom:6px;font-size:12px;}
.browser-tab{
  padding:2px 8px;
  border-radius:999px;
  background:rgba(15,23,42,0.96);
  border:1px solid rgba(148,163,184,0.7);
  font-size:11px;
}
.browser-url{
  flex:1;height:26px;border-radius:999px;border:1px solid rgba(75,85,99,.95);
  background:rgba(15,23,42,.95);color:var(--text-main);padding:0 10px;font-size:12px;outline:none;
}
.browser-go{
  height:26px;min-width:40px;border-radius:999px;border:1px solid rgba(55,65,81,.95);
  background:rgba(17,24,39,.96);color:var(--text-main);font-size:12px;cursor:pointer;
}
.browser-area{
  flex:1;border-radius:10px;border:1px solid rgba(55,65,81,.9);background:#020617;
  color:#e5e7eb;padding:10px;font-family:system-ui,sans-serif;font-size:13px;overflow:auto;
}

/* Settings */
.settings-app{display:flex;height:100%;font-size:12px}
.settings-sidebar{
  width:160px;border-right:1px solid rgba(55,65,81,.9);padding:8px 6px;display:flex;flex-direction:column;gap:4px;
}
.settings-item{
  padding:6px 8px;border-radius:6px;cursor:pointer;color:var(--text-main);
}
.settings-item:hover{background:rgba(31,41,55,.9);}
.settings-item-active{background:rgba(37,99,235,.6);}
.settings-main{flex:1;padding:10px;overflow:auto}
.settings-panel h2{font-size:15px;margin-bottom:6px;}
.settings-section{margin-top:10px;font-size:12px}
.setting-row{margin-bottom:6px;}
.setting-group-title{font-weight:600;margin-bottom:4px;}
.setting-options{display:flex;flex-wrap:wrap;gap:6px;}
.settings-toggle-row{display:flex;align-items:center;gap:8px;margin-bottom:8px;}

.settings-radio-btn,
.settings-accent-btn,
.settings-wall-btn,
.theme-btn{
  padding:4px 10px;border-radius:999px;border:1px solid rgba(75,85,99,0.9);
  background:rgba(15,23,42,0.95);color:var(--text-main);font-size:12px;cursor:pointer;
}
.settings-toggle{
  width:30px;height:16px;border-radius:999px;border:1px solid rgba(75,85,99,0.9);
  cursor:pointer;position:relative;background:rgba(15,23,42,0.95);
}
.settings-toggle-knob{
  position:absolute;width:14px;height:14px;border-radius:999px;background:#e5e7eb;top:0;left:0;
  transform:translate(0,0);transition:transform .12s;
}
.settings-toggle.on .settings-toggle-knob{transform:translate(14px,0);}
.glass-slider{width:100%;margin-top:6px;}

/* Notes */
.notes-area{
  width:100%;height:100%;border-radius:10px;border:1px solid rgba(55,65,81,.9);
  background:rgba(15,23,42,.95);color:var(--text-main);padding:8px;font-size:13px;resize:none;outline:none;
}

/* This PC */
.thispc-app{height:100%;display:flex}
.thispc-nav{
  width:140px;border-right:1px solid rgba(55,65,81,.9);padding:6px;font-size:12px;
}
.thispc-nav-item{padding:5px 6px;border-radius:6px;cursor:pointer;}
.thispc-nav-item:hover{background:rgba(31,41,55,.9);}
.thispc-nav-item.active{background:rgba(37,99,235,.6);}
.thispc-main{flex:1;padding:8px;font-size:12px;overflow:auto}

/* Recycle bin */
.recycle-bin-window{display:flex;flex-direction:column;height:100%}
.recycle-bin-header{display:flex;justify-content:flex-end;margin-bottom:6px}
.rb-list{flex:1;overflow:auto;border-radius:10px;border:1px solid rgba(55,65,81,.9);padding:6px;}
.rb-empty-msg{font-size:12px;color:var(--text-sub);}
.rb-item{display:flex;justify-content:space-between;align-items:center;padding:4px 0;border-bottom:1px solid rgba(31,41,55,.9);}
.rb-item-actions button{
  padding:2px 8px;border-radius:999px;border:1px solid rgba(59,130,246,.9);
  background:rgba(15,23,42,.95);color:var(--text-main);font-size:11px;cursor:pointer;margin-left:2px;
}

/* Store */
.store-app{font-size:12px}
.store-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:8px;margin-top:8px;}
.store-card{
  border-radius:10px;padding:6px;border:1px solid rgba(55,65,81,.9);
  background:rgba(15,23,42,.95);
}
.store-card-title{font-weight:600;font-size:12px;margin-bottom:2px;}
.store-card-desc{font-size:11px;color:var(--text-sub);margin-bottom:4px;}
.store-card-buttons{display:flex;gap:6px;margin-top:4px;}

/* Toast */
#toast{
  position:fixed;bottom:56px;right:10px;min-width:180px;max-width:260px;
  padding:8px 10px;background:rgba(15,23,42,.98);border-radius:8px;
  border:1px solid rgba(59,130,246,.8);color:var(--text-main);font-size:12px;
  opacity:0;transform:translateY(10px);pointer-events:none;transition:opacity .15s,transform .15s;
  z-index:900;
}
#toast.show{opacity:1;transform:translateY(0);}
</style>
</head>
<body>

<!-- BIOS -->
<div id="bios">
  <div id="bios-title">Liquid Plastic UEFI BIOS v1.0</div>
  <div>Copyright (c) 2026 Curtis Labs</div>
  <div style="margin-top:6px;">CPU: Virtual Glass Core</div>
  <div>Memory: 8192 MB</div>
  <div>Boot device: LP-SSD0</div>
  <div id="bios-bar"><div id="bios-bar-inner"></div></div>
  <div class="hint">Press any key or click to continue...</div>
</div>

<!-- Lockscreen -->
<div id="lockscreen">
  <div class="lock-panel">
    <div class="lock-panel-inner">
      <div class="lock-time" id="lockTime">3:48 PM</div>
      <div class="lock-date" id="lockDate">Saturday, January 3</div>
      <div class="account-pill" id="lockAccount">
        <div class="avatar">C</div>
        <div class="lock-user">
          Curtis<br>
          <span class="lock-user-sub">Liquid Plastic</span>
        </div>
      </div>
      <div id="lockHint">Click your name or press any key to sign in.</div>
    </div>
  </div>
</div>

<!-- Desktop -->
<div class="desktop" id="desktopRoot">
  <div class="glow g1"></div>
  <div class="glow g2"></div>
  <div class="glow g3"></div>
  <div id="desktopIcons"></div>
</div>

<div id="selectBox"></div>
<div id="ctxMenu"><div class="inner glass-ui"></div></div>

<div id="startMenu"><div class="inner glass-ui"></div></div>
<div id="notifPanel"><div class="inner glass-ui"></div></div>
<div id="taskbar"></div>

<div id="toast"></div>

<script>
/* -------------------------
   Utilities and state
   ------------------------- */
const $  = (q, root=document) => root.querySelector(q);
const $$ = (q, root=document) => Array.from(root.querySelectorAll(q));

const OS = {
  config:{
    desktopGrid:80,
    clock24:false,
    taskbarAutohide:false,
    glassLevel:0.8
  },
  state:{
    bootDone:false,
    locked:true,
    desktopIcons:[],
    windows:[],
    activeWindow:null,
    nextZ:200,
    apps:{},
    notifications:[],
    startMenuOpen:false,
    notifOpen:false,
    recycleBin:[],
    passwordEnabled:false,
    passwordHash:null
  }
};

/* Load persisted glass level and password settings if present */
(function(){
  try{
    const v = localStorage.getItem("lp-glass");
    if(v!==null){
      const n = Number(v);
      if(!isNaN(n) && n>0 && n<=1) OS.config.glassLevel = n;
    }
    const pwEnabled = localStorage.getItem("lp-password-enabled");
    if(pwEnabled==="1") OS.state.passwordEnabled = true;
    const ph = localStorage.getItem("lp-password-hash");
    if(ph) OS.state.passwordHash = ph;
  }catch(e){}
})();

/* Simple hash for password (not cryptographically secure but fine for demo) */
function simpleHash(s){
  let h=2166136261;
  for(let i=0;i<s.length;i++){h ^= s.charCodeAt(i); h += (h<<1)+(h<<4)+(h<<7)+(h<<8)+(h<<24);}
  return (h>>>0).toString(16);
}

/* Toast + notifications */
function showToast(msg){
  const t=$("#toast");
  if(!t) return;
  t.textContent=msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"),2000);
}
function notify(title,message){
  OS.state.notifications.unshift({
    id:Date.now()+"-"+Math.random().toString(16).slice(2),
    title,message,time:new Date()
  });
  renderNotifications();
  renderTaskbar();
}

/* -------------------------
   BIOS boot
   ------------------------- */
function startBoot(){
  const bios = $("#bios");
  const bar  = $("#bios-bar-inner");

  if (!bios || !bar) {
    finishBootNoBIOS();
    return;
  }

  let progress = 0;
  let finished = false;

  function finishBootCommon(){
    if (finished) return;
    finished = true;
    OS.state.bootDone = true;
    bios.style.transition = "opacity .3s";
    bios.style.opacity = "0";
    setTimeout(() => {
      bios.remove();
      initDesktop();
      showLockscreen(true);
      notify("Welcome","Liquid Plastic OS 1.x ready.");
    }, 320);
  }

  const interval = setInterval(() => {
    if (finished) {
      clearInterval(interval);
      return;
    }
    progress += 5;
    if (progress > 100) progress = 100;
    bar.style.width = progress + "%";

    if (progress >= 100) {
      clearInterval(interval);
      setTimeout(finishBootCommon, 300);
    }
  }, 80);

  const skip = () => {
    clearInterval(interval);
    finishBootCommon();
  };
  window.addEventListener("keydown", skip, { once: true });
  window.addEventListener("click",   skip, { once: true });
}
function finishBootNoBIOS(){
  OS.state.bootDone = true;
  initDesktop();
  showLockscreen(true);
  notify("Welcome","Liquid Plastic OS 1.x ready.");
}

/* -------------------------
   Lockscreen (password-aware)
   ------------------------- */
let lockInterval=null;

function updateLockTime(){
  const now=new Date();
  const use24=OS.config.clock24;
  let h24=now.getHours();
  let h=h24%12||12;
  const m=String(now.getMinutes()).padStart(2,"0");
  const ampm=h24>=12?"PM":"AM";
  const lt=$("#lockTime");
  const ld=$("#lockDate");
  if(lt) lt.textContent = use24 ? `${String(h24).padStart(2,"0")}:${m}` : `${h}:${m} ${ampm}`;
  if(ld){
    const opts={weekday:"long",month:"long",day:"numeric"};
    ld.textContent=now.toLocaleDateString(undefined,opts);
  }
}
function showLockscreen(first=false){
  OS.state.locked=true;
  const ls=$("#lockscreen");
  if(!ls) return;
  ls.style.display="flex";
  updateLockTime();
  ls.classList.add("visible");

  if(lockInterval) clearInterval(lockInterval);
  lockInterval=setInterval(()=>{if(OS.state.locked) updateLockTime();},30000);

  const unlockHandler=async ()=>{
    if(!OS.state.locked) return;
    if(OS.state.passwordEnabled && OS.state.passwordHash){
      // show a prompt modal (simple prompt for demo)
      const attempt = prompt("Enter password to unlock:");
      if(attempt===null) return; // cancelled
      const h = simpleHash(attempt);
      if(h !== OS.state.passwordHash){
        alert("Incorrect password.");
        return;
      }
    }
    OS.state.locked=false;
    ls.classList.remove("visible");
    setTimeout(()=>{ls.style.display="none";},250);
  };

  $("#lockAccount").onclick=unlockHandler;
  window.onkeydown=(e)=>{ if(OS.state.locked) unlockHandler(); };
}

/* -------------------------
   Desktop icons (start empty by default)
   ------------------------- */
function seedDesktopIcons(){
  // Start with an empty desktop; users can drag from Start to create shortcuts
  OS.state.desktopIcons = [];
}
function renderDesktopIcons(){
  const layer=$("#desktopIcons");
  if(!layer) return;
  layer.innerHTML="";
  OS.state.desktopIcons.forEach((icon,index)=>{
    const el=document.createElement("div");
    el.className="icon";
    if(icon.type==="folder") el.classList.add("folder");
    el.dataset.index=index;
    el.style.left=icon.x+"px";
    el.style.top=icon.y+"px";

    let bodyHTML='<div class="icon-body"></div>';
    if(icon.type==="folder"){
      bodyHTML=`
        <div class="icon-body">
          <div class="folder-grid-preview">
            ${Array.from({length: Math.min(4, (icon.children||[]).length)}).map(()=>"<div></div>").join("")}
          </div>
        </div>`;
    }
    el.innerHTML= bodyHTML + `<div class="icon-label" data-label-index="${index}">${icon.name}</div>`;

    if(icon.selected) el.classList.add("selected");

    /* mousedown selection (do not start drag here) */
    el.addEventListener("mousedown",(e)=>{
      if(e.button!==0) return;
      e.stopPropagation();
      const multi=e.ctrlKey||e.metaKey||e.shiftKey;
      if(!multi){
        OS.state.desktopIcons.forEach(i=>i.selected=false);
      }
      icon.selected=!icon.selected;
      renderDesktopIcons();
    });

    /* double click to open */
    el.addEventListener("dblclick",()=>{
      if(icon.type==="folder") openAppFolder(icon);
      else if(icon.appId) openApp(icon.appId);
    });

    /* right click context menu */
    el.addEventListener("contextmenu",(e)=>{
      e.preventDefault();
      e.stopPropagation();
      showDesktopContextMenuForIcon(icon,index,e.clientX,e.clientY);
    });

    layer.appendChild(el);
  });
}

/* Inline rename (Windows-like) */
function startRenameIcon(index){
  const el = $(`.icon[data-index="${index}"]`);
  if(!el) return;
  const labelEl = el.querySelector(".icon-label");
  if(!labelEl) return;
  const old = labelEl.textContent;
  const input = document.createElement("input");
  input.type="text";
  input.value=old;
  input.style.width="100%";
  input.style.background="transparent";
  input.style.border="1px solid rgba(148,163,184,.4)";
  input.style.color="var(--text-main)";
  input.style.borderRadius="6px";
  input.style.padding="2px";
  labelEl.replaceWith(input);
  input.focus();
  input.select();
  function finish(){
    const val = input.value.trim() || old;
    OS.state.desktopIcons[index].name = val;
    renderDesktopIcons();
  }
  input.addEventListener("blur", finish);
  input.addEventListener("keydown",(e)=>{
    if(e.key==="Enter"){ input.blur(); }
    if(e.key==="Escape"){ renderDesktopIcons(); }
  });
}

/* -------------------------
   App folder window
   ------------------------- */
function openAppFolder(folderIcon){
  const root=document.createElement("div");
  root.innerHTML=`
    <h3 style="margin-bottom:6px;">${folderIcon.name}</h3>
    <div style="display:flex;flex-wrap:wrap;gap:6px;">
      ${ (folderIcon.children||[]).slice(0,32).map(id=>{
        const app=OS.state.apps[id];
        return `<button style="min-width:80px;padding:4px 6px;border-radius:8px;border:1px solid rgba(55,65,81,.9);background:rgba(15,23,42,.9);font-size:12px;cursor:pointer;">${app?app.title:id}</button>`;
      }).join("")}
    </div>
  `;
  const win=createWindow("folder-"+folderIcon.id,folderIcon.name,root);
  $$(".win-body button",win).forEach(btn=>{
    const text=btn.textContent;
    const id=Object.keys(OS.state.apps).find(k=>OS.state.apps[k].title===text);
    if(id){
      btn.addEventListener("click",()=>openApp(id));
    }
  });
}

/* -------------------------
   Selection box
   ------------------------- */
let selStartX=0, selStartY=0, selecting=false;
function enableSelectionBox(){
  const box=$("#selectBox");
  if(!box) return;
  document.addEventListener("mousedown",(e)=>{
    if(e.button!==0) return;
    if(e.target.closest(".window")) return;
    if(e.target.closest(".icon")||e.target.closest("#taskbar")||e.target.closest("#startMenu")||e.target.closest("#notifPanel")) return;

    selecting=true;
    selStartX=e.clientX;
    selStartY=e.clientY;
    box.style.left=selStartX+"px";
    box.style.top=selStartY+"px";
    box.style.width="0px";
    box.style.height="0px";
    box.style.display="block";
    OS.state.desktopIcons.forEach(i=>i.selected=false);
    renderDesktopIcons();
  });
  document.addEventListener("mousemove",(e)=>{
    if(!selecting) return;
    const x=Math.min(selStartX,e.clientX);
    const y=Math.min(selStartY,e.clientY);
    const w=Math.abs(e.clientX-selStartX);
    const h=Math.abs(e.clientY-selStartY);
    box.style.left=x+"px";
    box.style.top=y+"px";
    box.style.width=w+"px";
    box.style.height=h+"px";
    const icons=$$(".icon");
    icons.forEach(el=>{
      const rect=el.getBoundingClientRect();
      const overlap=rect.left < x+w && rect.right > x && rect.top < y+h && rect.bottom > y;
      const idx=parseInt(el.dataset.index,10);
      OS.state.desktopIcons[idx].selected=overlap;
    });
    renderDesktopIcons();
  });
  document.addEventListener("mouseup",()=>{
    if(selecting){
      selecting=false;
      box.style.display="none";
    }
  });
}

/* -------------------------
   Dragging + folder stacking (multi-select moves)
   ------------------------- */
let draggingIcons=false, dragStartX=0, dragStartY=0, iconStartPositions=[];
function enableIconDragging(){
  document.addEventListener("mousedown",(e)=>{
    if(e.button!==0) return;
    const iconEl=e.target.closest(".icon");
    if(!iconEl) return;

    // start drag
    draggingIcons=true;
    dragStartX=e.clientX;
    dragStartY=e.clientY;

    const idx=parseInt(iconEl.dataset.index,10);
    const icon=OS.state.desktopIcons[idx];

    // selection behaviour: if clicked icon not selected, select only it
    if(!icon.selected){
      OS.state.desktopIcons.forEach(i=>i.selected=false);
      icon.selected=true;
      renderDesktopIcons();
    }

    iconStartPositions=OS.state.desktopIcons.map((i,index)=>({
      index,
      x:i.x,
      y:i.y,
      selected:i.selected
    })).filter(i=>i.selected);

    document.body.style.userSelect="none";
  });

  document.addEventListener("mousemove",(e)=>{
    if(!draggingIcons) return;
    const dx=e.clientX-dragStartX;
    const dy=e.clientY-dragStartY;
    iconStartPositions.forEach(info=>{
      const icon=OS.state.desktopIcons[info.index];
      icon.x=info.x+dx;
      icon.y=info.y+dy;
    });
    renderDesktopIcons();
  });

  document.addEventListener("mouseup",(e)=>{
    if(!draggingIcons) return;
    draggingIcons=false;
    document.body.style.userSelect="";

    const grid=OS.config.desktopGrid;

    const sel=OS.state.desktopIcons.filter(i=>i.selected);
    if(sel.length===1){
      const dragged=sel[0];
      const draggedRect=getIconRect(dragged);
      const target=OS.state.desktopIcons.find(i=>i!==dragged && overlapRect(draggedRect,getIconRect(i)));
      if(target){
        if(target.type!=="folder"){
          const folder={
            id:"folder-"+Date.now(),
            name:"App Folder",
            appId:null,
            x:target.x,
            y:target.y,
            selected:false,
            type:"folder",
            children:[target.appId,dragged.appId].filter(Boolean)
          };
          OS.state.desktopIcons=OS.state.desktopIcons.filter(i=>i!==dragged && i!==target);
          OS.state.desktopIcons.push(folder);
        }else{
          if(dragged.appId && !target.children.includes(dragged.appId)){
            target.children.push(dragged.appId);
          }
          OS.state.desktopIcons=OS.state.desktopIcons.filter(i=>i!==dragged);
        }
        renderDesktopIcons();
        return;
      }
    }

    OS.state.desktopIcons.forEach(icon=>{
      icon.x=Math.round(icon.x/grid)*grid;
      icon.y=Math.round(icon.y/grid)*grid;
    });
    renderDesktopIcons();
  });
}
function getIconRect(icon){
  const idx=OS.state.desktopIcons.indexOf(icon);
  const el=$(`.icon[data-index="${idx}"]`);
  return el?el.getBoundingClientRect():{left:0,top:0,right:0,bottom:0};
}
function overlapRect(a,b){
  return a.left<b.right && a.right>b.left && a.top<b.bottom && a.bottom>b.top;
}

/* -------------------------
   Desktop context menu
   ------------------------- */
function showDesktopContextMenuForIcon(icon,index,x,y){
  const menu=$("#ctxMenu");
  const inner=menu.querySelector(".inner");
  inner.innerHTML=`
    <div class="ctx-item" data-act="open">Open</div>
    <div class="ctx-item" data-act="rename">Rename</div>
    <div class="ctx-item" data-act="pin">Pin / Unpin from Start</div>
    <div class="ctx-item" data-act="remove">Remove from Desktop</div>
  `;
  menu.style.left=x+"px";
  menu.style.top=y+"px";
  menu.style.display="block";

  // ensure clicks inside menu don't close it prematurely
  inner.querySelectorAll(".ctx-item").forEach(item=>{
    item.onclick=()=>{
      const a=item.dataset.act;
      if(a==="open"){
        if(icon.type==="folder") openAppFolder(icon);
        else if(icon.appId) openApp(icon.appId);
      }
      if(a==="rename"){
        // use inline rename
        startRenameIcon(index);
      }
      if(a==="pin"){
        togglePinStart(icon.appId);
      }
      if(a==="remove"){
        moveToRecycleBin(icon);
        OS.state.desktopIcons.splice(index,1);
        renderRecycleBinList();
      }
      renderDesktopIcons();
      menu.style.display="none";
    };
  });
}

/* -------------------------
   Window manager
   ------------------------- */
function createWindow(appId,title,contentNode){
  const win=document.createElement("div");
  win.className="window glass-win hidden";
  win.dataset.appId=appId;
  const header=document.createElement("div");
  header.className="win-header";
  header.innerHTML=`
    <div class="win-title">${title}</div>
    <div class="win-controls">
      <button class="win-btn" data-min>-</button>
      <button class="win-btn" data-max>□</button>
      <button class="win-btn" data-close>×</button>
    </div>
  `;
  const body=document.createElement("div");
  body.className="win-body";
  if(contentNode) body.appendChild(contentNode);
  const resizeHandle=document.createElement("div");
  resizeHandle.className="window-resize-handle";
  win.appendChild(header);
  win.appendChild(body);
  win.appendChild(resizeHandle);
  document.body.appendChild(win);

  win.style.left=(140+OS.state.windows.length*28)+"px";
  win.style.top=(80+OS.state.windows.length*22)+"px";
  win.style.zIndex=OS.state.nextZ++;
  OS.state.windows.push(win);

  enableWindowDragging(win,header);
  hookWindowControls(win);
  enableWindowResize(win,resizeHandle);
  focusWindow(win);
  requestAnimationFrame(()=>{
    win.style.display="flex";
    win.classList.remove("hidden");
    win.classList.add("visible");
  });
  renderTaskbar();
  return win;
}
function focusWindow(win){
  OS.state.windows.forEach(w=>w.style.zIndex=200);
  win.style.zIndex=OS.state.nextZ++;
  OS.state.activeWindow=win;
  renderTaskbar();
}
function hookWindowControls(win){
  const btnMin=win.querySelector("[data-min]");
  const btnMax=win.querySelector("[data-max]");
  const btnClose=win.querySelector("[data-close]");
  btnMin.onclick=()=>{
    win.style.display="none";
    renderTaskbar();
  };
  btnMax.onclick=()=>{
    if(win.classList.contains("maximized")){
      win.classList.remove("maximized");
      win.style.position="absolute";
      win.style.left="140px";
      win.style.top="80px";
      win.style.width="";win.style.height="";
    }else{
      win.classList.add("maximized");
      win.style.position="fixed";
      win.style.left="0";win.style.top="0";
      win.style.width="100vw";win.style.height="100vh";
    }
  };
  btnClose.onclick=()=>{
    win.remove();
    OS.state.windows=OS.state.windows.filter(w=>w!==win);
    if(OS.state.activeWindow===win) OS.state.activeWindow=null;
    renderTaskbar();
  };
  win.addEventListener("mousedown",()=>focusWindow(win));
}
function enableWindowDragging(win,header){
  let dragging=false,sx=0,sy=0,wl=0,wt=0;
  header.addEventListener("mousedown",(e)=>{
    if(e.button!==0) return;
    dragging=true;
    sx=e.clientX;sy=e.clientY;
    const r=win.getBoundingClientRect();
    wl=r.left;wt=r.top;
    win.classList.add("dragging");
    document.body.style.userSelect="none";
  });
  document.addEventListener("mousemove",(e)=>{
    if(!dragging) return;
    const dx=e.clientX-sx;
    const dy=e.clientY-sy;
    win.style.left=wl+dx+"px";
    win.style.top=wt+dy+"px";
  });
  document.addEventListener("mouseup",()=>{
    if(!dragging) return;
    dragging=false;
    win.classList.remove("dragging");
    document.body.style.userSelect="";
  });
}
function enableWindowResize(win,handle){
  let resizing=false,startX=0,startY=0,startW=0,startH=0;
  handle.addEventListener("mousedown",(e)=>{
    e.stopPropagation();
    e.preventDefault();
    resizing=true;
    startX=e.clientX;
    startY=e.clientY;
    const rect=win.getBoundingClientRect();
    startW=rect.width;
    startH=rect.height;
    document.body.style.userSelect="none";
  });
  document.addEventListener("mousemove",(e)=>{
    if(!resizing) return;
    const dx=e.clientX-startX;
    const dy=e.clientY-startY;
    win.style.width=Math.max(320,startW+dx)+"px";
    win.style.height=Math.max(200,startH+dy)+"px";
  });
  document.addEventListener("mouseup",()=>{
    if(!resizing) return;
    resizing=false;
    document.body.style.userSelect="";
  });
}

/* -------------------------
   App registry
   ------------------------- */
function registerApp(id,def){OS.state.apps[id]=def;}
function openApp(id){
  const app=OS.state.apps[id];
  if(!app){
    showToast(`App "${id}" is not installed.`);
    return null;
  }
  const existing=OS.state.windows.find(w=>w.dataset.appId===id);
  if(existing){
    existing.style.display="flex";
    focusWindow(existing);
    return existing;
  }
  const content=app.createContent();
  const win=createWindow(id,app.title,content);
  return win;
}

/* -------------------------
   Browser app
   ------------------------- */
registerApp("browser",{
  title:"Liquid Plastic Browser",
  createContent(){
    const root=document.createElement("div");
    root.className="browser-app";
    root.innerHTML=`
      <div class="browser-bar">
        <div class="browser-tab"><span>LP X</span></div>
        <input class="browser-url" placeholder="lp://home" />
        <button class="browser-go">Go</button>
      </div>
      <div class="browser-area" id="lpBrowserArea"></div>
    `;
    setupLPBrowser(root);
    return root;
  }
});
function renderLPPage(area,url){
  const page=url.toLowerCase();
  if(page==="lp://home" || page==="lp:/home"){
    area.innerHTML=`
      <h2>Liquid Plastic Browser</h2>
      <div style="font-size:12px;color:var(--text-sub);margin-bottom:6px;">lp://home</div>
      <p>Welcome. Try <strong>lp://about</strong>, <strong>lp://apps</strong>, <strong>lp://bookmarks</strong>.</p>
    `;
  }else if(page==="lp://about"){
    area.innerHTML=`
      <h2>About Liquid Plastic</h2>
      <p style="font-size:13px;">A glassy virtual OS interface running inside your browser.</p>
    `;
  }else if(page==="lp://apps"){
    const appsList=Object.keys(OS.state.apps).map(id=>OS.state.apps[id].title).join(", ");
    area.innerHTML=`
      <h2>Installed apps</h2>
      <p style="font-size:13px;">${appsList||"No apps registered."}</p>
    `;
  }else if(page==="lp://bookmarks"){
    area.innerHTML=`
      <h2>Bookmarks</h2>
      <p style="font-size:13px;">No bookmarks yet. (Future feature.)</p>
    `;
  }else{
    area.innerHTML=`
      <h2>Unknown lp:// page</h2>
      <p style="font-size:13px;">${url}</p>
    `;
  }
}
function setupLPBrowser(root){
  const urlInput=root.querySelector(".browser-url");
  const goBtn=root.querySelector(".browser-go");
  const area=root.querySelector(".browser-area");

  function navigate(url){
    if(!url) url="lp://home";
    if(!url.startsWith("lp://")) url="lp://home";
    urlInput.value=url;
    renderLPPage(area,url);
  }
  goBtn.onclick=()=>navigate(urlInput.value.trim());
  urlInput.addEventListener("keydown",(e)=>{if(e.key==="Enter") navigate(urlInput.value.trim());});
  navigate("lp://home");
}

/* -------------------------
   Settings app (root-scoped)
   ------------------------- */
registerApp("settings",{
  title:"Settings",
  createContent(){
    const root=document.createElement("div");
    root.className="settings-app";
    root.innerHTML=`
      <div class="settings-sidebar">
        <div class="settings-item" data-panel="appearance">Appearance</div>
        <div class="settings-item" data-panel="system">System</div>
        <div class="settings-item" data-panel="account">Account</div>
        <div class="settings-item" data-panel="glass">Glass</div>
      </div>
      <div class="settings-main">
        <div class="settings-panel" data-panel-id="appearance"></div>
        <div class="settings-panel" data-panel-id="system"></div>
        <div class="settings-panel" data-panel-id="account"></div>
        <div class="settings-panel" data-panel-id="glass"></div>
      </div>
    `;
    setupSettings(root);
    return root;
  }
});

function setupSettings(root){
  const items=Array.from(root.querySelectorAll(".settings-item"));
  const panels={
    appearance: root.querySelector('.settings-panel[data-panel-id="appearance"]'),
    system:     root.querySelector('.settings-panel[data-panel-id="system"]'),
    account:    root.querySelector('.settings-panel[data-panel-id="account"]'),
    glass:      root.querySelector('.settings-panel[data-panel-id="glass"]')
  };

  renderAppearancePanel(panels.appearance);
  renderSystemPanel(panels.system);
  renderAccountPanel(panels.account);
  renderGlassPanel(panels.glass);

  function showSettingsPanel(name){
    Object.values(panels).forEach(p=>{ if(p) p.style.display="none"; });
    if(panels[name]) panels[name].style.display="block";
  }

  items.forEach(it=>{
    it.onclick=()=>{
      items.forEach(i=>i.classList.remove("settings-item-active"));
      it.classList.add("settings-item-active");
      showSettingsPanel(it.dataset.panel);
    };
  });

  items[0].classList.add("settings-item-active");
  showSettingsPanel("appearance");
}

function renderAppearancePanel(panel){
  if(!panel) return;
  panel.innerHTML=`
    <h2>Appearance</h2>
    <div class="settings-section">
      <div class="setting-group-title">Wallpaper</div>
      <div class="setting-options">
        <button class="settings-wall-btn" data-wall="default">Default</button>
        <button class="settings-wall-btn" data-wall="aurora">Aurora</button>
        <button class="settings-wall-btn" data-wall="forest">Forest</button>
        <button class="settings-wall-btn" data-wall="sunset">Sunset</button>
        <button class="settings-wall-btn" data-wall="mono">Mono</button>
        <button class="settings-wall-btn" data-wall="upload">Upload wallpaper</button>
      </div>
    </div>
    <div class="settings-section">
      <div class="setting-group-title">Accent color</div>
      <div class="setting-options">
        <button class="settings-accent-btn" data-accent="#4aa8ff">Blue</button>
        <button class="settings-accent-btn" data-accent="#22c55e">Green</button>
        <button class="settings-accent-btn" data-accent="#f97316">Orange</button>
        <button class="settings-accent-btn" data-accent="#ec4899">Pink</button>
        <button class="settings-accent-btn" data-accent="#a855f7">Purple</button>
      </div>
    </div>
    <div class="settings-section">
      <div class="setting-group-title">Window corners</div>
      <div class="setting-options">
        <button class="settings-radio-btn" data-corners="rounded">Rounded</button>
        <button class="settings-radio-btn" data-corners="sharp">Sharp</button>
      </div>
    </div>
    <div class="settings-section">
      <div class="setting-group-title">Clock format</div>
      <div class="setting-options">
        <button class="settings-radio-btn" data-clock="12">12 hour</button>
        <button class="settings-radio-btn" data-clock="24">24 hour</button>
      </div>
    </div>
  `;
  const desktopRoot=$("#desktopRoot");

  panel.querySelectorAll(".settings-wall-btn").forEach(btn=>{
    btn.onclick=()=>{
      const w=btn.dataset.wall;
      if(desktopRoot){
        if(w==="default") desktopRoot.style.background= "var(--bg-gradient)";
        if(w==="aurora") desktopRoot.style.background= "radial-gradient(circle at top,#1e3a8a,#020617)";
        if(w==="forest") desktopRoot.style.background= "radial-gradient(circle at top,#064e3b,#020617)";
        if(w==="sunset") desktopRoot.style.background= "radial-gradient(circle at top,#b91c1c,#020617)";
        if(w==="mono") desktopRoot.style.background= "radial-gradient(circle at top,#111827,#020617)";
      }
      if(w==="upload") showToast("Upload wallpaper not implemented yet.");
      panel.querySelectorAll(".settings-wall-btn").forEach(x=>x.classList.remove("active"));
      btn.classList.add("active");
    };
  });

  panel.querySelectorAll(".settings-accent-btn").forEach(btn=>{
    btn.onclick=()=>{
      const c=btn.dataset.accent;
      document.documentElement.style.setProperty("--accent",c);
      panel.querySelectorAll(".settings-accent-btn").forEach(x=>x.classList.remove("active"));
      btn.classList.add("active");
    };
  });

  panel.querySelectorAll(".settings-radio-btn[data-corners]").forEach(btn=>{
    btn.onclick=()=>{
      const v=btn.dataset.corners;
      document.documentElement.style.setProperty("--radius", v==="rounded" ? "18px" : "4px");
      panel.querySelectorAll(".settings-radio-btn[data-corners]").forEach(x=>x.classList.remove("active"));
      btn.classList.add("active");
    };
  });

  panel.querySelectorAll(".settings-radio-btn[data-clock]").forEach(btn=>{
    btn.onclick=()=>{
      const v=btn.dataset.clock;
      OS.config.clock24 = (v==="24");
      updateClock();
      updateLockTime();
      panel.querySelectorAll(".settings-radio-btn[data-clock]").forEach(x=>x.classList.remove("active"));
      btn.classList.add("active");
    };
  });
}

function renderSystemPanel(panel){
  if(!panel) return;
  panel.innerHTML=`
    <h2>System</h2>
    <div class="settings-section">
      <div class="settings-toggle-row">
        <div class="settings-toggle" id="sysTaskbarAuto"><div class="settings-toggle-knob"></div></div>
        <div>Taskbar auto-hide</div>
      </div>
      <div style="font-size:11px;color:var(--text-sub);margin-top:4px;">
        Hide taskbar until cursor is at the bottom edge. (Visual only in this build.)
      </div>
    </div>
    <div class="settings-section" style="margin-top:16px;font-size:11px;color:var(--text-sub);">
      More system settings can go here later.
    </div>
  `;
  const toggle=panel.querySelector("#sysTaskbarAuto");
  function updateToggle(){toggle.classList.toggle("on",OS.config.taskbarAutohide);}
  toggle.onclick=()=>{
    OS.config.taskbarAutohide=!OS.config.taskbarAutohide;
    updateToggle();
    showToast("Taskbar auto-hide is visual only in this build.");
    notify("System","Taskbar auto-hide toggled (visual only).");
  };
  updateToggle();
}

/* Account panel: add password textbox and enable toggle */
function renderAccountPanel(panel){
  if(!panel) return;
  panel.innerHTML=`
    <h2>Account</h2>
    <div class="settings-section">
      <div class="setting-row">
        <div style="margin-bottom:4px;">Current profile picture</div>
        <div style="width:42px;height:42px;border-radius:999px;background:conic-gradient(from 140deg,#38bdf8,#a855f7,#f97316,#22c55e);display:flex;align-items:center;justify-content:center;color:#020617;font-weight:700;font-size:18px;">C</div>
      </div>
      <div class="setting-row">
        <div>Account name</div>
        <input id="accName" type="text" value="Curtis" style="width:200px;padding:4px;border-radius:6px;border:1px solid rgba(75,85,99,.9);background:rgba(15,23,42,.95);color:var(--text-main);font-size:12px;">
      </div>
      <div class="setting-row">
        <div>Avatar initials</div>
        <input id="accInitials" type="text" value="C" style="width:40px;padding:4px;border-radius:6px;border:1px solid rgba(75,85,99,.9);background:rgba(15,23,42,.95);color:var(--text-main);font-size:12px;">
      </div>
      <div class="setting-row">
        <div>Avatar picture</div>
        <button class="theme-btn" id="accUploadBtn">Upload profile picture</button>
      </div>
      <div class="setting-row">
        <div class="settings-toggle-row">
          <div class="settings-toggle" id="accPwOnUnlock"><div class="settings-toggle-knob"></div></div>
          <div>Require password on unlock</div>
        </div>
      </div>
      <div class="setting-row">
        <label style="font-size:12px;"><input id="accPromptLock" type="checkbox"> Prompt for password on lockscreen</label>
      </div>
      <div class="setting-row">
        <div>Password</div>
        <input id="accPasswordInput" type="password" placeholder="Set password" style="width:200px;padding:4px;border-radius:6px;border:1px solid rgba(75,85,99,.9);background:rgba(15,23,42,.95);color:var(--text-main);font-size:12px;">
        <button class="theme-btn" id="accSavePassword" style="margin-left:6px;">Save</button>
      </div>
    </div>
  `;

  // wire up password controls
  const toggle = panel.querySelector("#accPwOnUnlock");
  function updateToggle(){ toggle.classList.toggle("on", OS.state.passwordEnabled); }
  toggle.onclick=()=>{
    OS.state.passwordEnabled = !OS.state.passwordEnabled;
    try{ localStorage.setItem("lp-password-enabled", OS.state.passwordEnabled ? "1" : "0"); }catch(e){}
    updateToggle();
    showToast("Password requirement toggled.");
  };
  updateToggle();

  const pwInput = panel.querySelector("#accPasswordInput");
  const saveBtn = panel.querySelector("#accSavePassword");
  saveBtn.onclick=()=>{
    const v = pwInput.value.trim();
    if(!v){
      // clear password
      OS.state.passwordHash = null;
      try{ localStorage.removeItem("lp-password-hash"); }catch(e){}
      showToast("Password cleared.");
      return;
    }
    const h = simpleHash(v);
    OS.state.passwordHash = h;
    try{ localStorage.setItem("lp-password-hash", h); }catch(e){}
    showToast("Password saved.");
  };

  panel.querySelector("#accUploadBtn").onclick=()=>{
    showToast("Upload not implemented in this build.");
  };
  panel.querySelector("#accPromptLock").onchange=(e)=>{
    // just UI-only checkbox for now
  };
}

/* -------------------------
   Glass panel (persist + correct presets)
   ------------------------- */
function renderGlassPanel(panel){
  if(!panel) return;

  // current level 0–1 → slider 0–100
  const currentPercent = Math.round((OS.config.glassLevel || 0.8) * 100);

  panel.innerHTML=`
    <h2>Glass</h2>
    <div class="settings-section">
      <div class="setting-group-title">Transparency presets</div>
      <div class="setting-options">
        <button class="settings-radio-btn" data-preset="glassy">Glassy</button>
        <button class="settings-radio-btn" data-preset="balanced">Balanced</button>
        <button class="settings-radio-btn" data-preset="solid">Solid</button>
      </div>
    </div>
    <div class="settings-section">
      <div class="setting-group-title">Custom level</div>
      <input type="range" min="0" max="100" value="${currentPercent}" class="glass-slider">
      <div style="font-size:11px;color:var(--text-sub);margin-top:4px;">
        Affects taskbar, icons, start menu, folders, context menus, notifications.
      </div>
    </div>
  `;

  const slider = panel.querySelector(".glass-slider");

  function applyGlass(level){
    const op = Math.max(0.1, level / 100);
    const iconOp = 0.5 + 0.5 * op;
    const borderAlpha = 0.3 + 0.4 * op;
    document.documentElement.style.setProperty("--glass-opacity", op.toString());
    document.documentElement.style.setProperty("--glass-border-alpha", borderAlpha.toString());
    document.documentElement.style.setProperty("--icon-glass-opacity", iconOp.toString());
    OS.config.glassLevel = op; // persist in memory
    try{ localStorage.setItem("lp-glass", String(op)); }catch(e){}
    // update visible elements immediately
    renderTaskbar();
    const panels = [$("#startMenu .inner"), $("#notifPanel .inner"), $("#ctxMenu .inner")];
    panels.forEach(p=>{ if(p) p.style.background = `rgba(15,23,42,${op})`; });
  }

  slider.oninput = () => {
    const v = Number(slider.value);
    applyGlass(v);
    updatePresetActive(v);
  };

  function updatePresetActive(v){
    const buttons = panel.querySelectorAll(".settings-radio-btn[data-preset]");
    buttons.forEach(b=>b.classList.remove("active"));

    // snap to preset ranges if close
    if(Math.abs(v-80) <= 6){
      panel.querySelector('[data-preset="glassy"]')?.classList.add("active");
    }else if(Math.abs(v-50) <= 6){
      panel.querySelector('[data-preset="balanced"]')?.classList.add("active");
    }else if(Math.abs(v-20) <= 6){
      panel.querySelector('[data-preset="solid"]')?.classList.add("active");
    }
  }

  panel.querySelectorAll(".settings-radio-btn[data-preset]").forEach(btn=>{
    btn.onclick = () => {
      const preset = btn.dataset.preset;
      let v = 80;
      if (preset === "glassy")   v = 80;
      if (preset === "balanced") v = 50;
      if (preset === "solid")    v = 20;
      slider.value = v;
      applyGlass(v);
      panel.querySelectorAll(".settings-radio-btn[data-preset]").forEach(x=>x.classList.remove("active"));
      btn.classList.add("active");
    };
  });

  // Initialize visual state from saved value
  slider.value = currentPercent;
  applyGlass(currentPercent);
  updatePresetActive(currentPercent);
}

/* -------------------------
   Notes, Calculator, Recycle, This PC, Store, Terminal, Task Manager
   ------------------------- */
registerApp("notes",{title:"Notes",createContent(){
  const root=document.createElement("div");
  root.innerHTML=`<textarea class="notes-area" id="notesArea"></textarea>`;
  const ta=root.querySelector("#notesArea");
  ta.value=localStorage.getItem("lp-notes")||"Start typing...";
  ta.oninput=()=>localStorage.setItem("lp-notes",ta.value);
  return root;
}});

registerApp("calculator",{
  title:"Calculator",
  createContent(){
    const root=document.createElement("div");
    root.style.fontSize="12px";
    root.innerHTML=`
      <div style="border-radius:10px;border:1px solid rgba(55,65,81,.9);background:#020617;padding:6px;width:220px;">
        <div id="calcDisplay" style="height:32px;border-radius:6px;background:#020617;color:#e5e7eb;border:1px solid rgba(55,65,81,.9);padding:4px 6px;text-align:right;font-size:14px;overflow:hidden;">0</div>
        <div style="margin-top:6px;display:grid;grid-template-columns:repeat(4,1fr);gap:4px;">
          <button data-key="7">7</button>
          <button data-key="8">8</button>
          <button data-key="9">9</button>
          <button data-key="/">÷</button>
          <button data-key="4">4</button>
          <button data-key="5">5</button>
          <button data-key="6">6</button>
          <button data-key="*">×</button>
          <button data-key="1">1</button>
          <button data-key="2">2</button>
          <button data-key="3">3</button>
          <button data-key="-">−</button>
          <button data-key="0">0</button>
          <button data-key=".">.</button>
          <button data-key="C">C</button>
          <button data-key="+">+</button>
          <button data-key="=" style="grid-column:span 4;">=</button>
        </div>
      </div>
    `;
    root.querySelectorAll("button").forEach(b=>{
      b.style.borderRadius="6px";
      b.style.border="1px solid rgba(55,65,81,.9)";
      b.style.background="rgba(15,23,42,.95)";
      b.style.color="var(--text-main)";
      b.style.cursor="pointer";
      b.style.padding="4px 0";
    });
    setupCalculator(root);
    return root;
  }
});
function setupCalculator(root){
  const display=root.querySelector("#calcDisplay");
  let expr="";

  function updateDisplay(){
    display.textContent = expr || "0";
  }
  function press(key){
    if(key==="C"){
      expr="";
      updateDisplay();
      return;
    }
    if(key==="="){
      try{
        const safe = expr.replace(/[^0-9+\-*/.()]/g,"");
        const val = Function(`"use strict";return (${safe||"0"})`)();
        expr = String(val);
      }catch{
        expr="Error";
      }
      updateDisplay();
      return;
    }
    if(expr==="Error") expr="";
    expr += key;
    updateDisplay();
  }
  root.querySelectorAll("[data-key]").forEach(btn=>{
    btn.onclick=()=>press(btn.dataset.key);
  });
}

registerApp("recycle-bin",{
  title:"Recycle Bin",
  createContent(){
    const root=document.createElement("div");
    root.className="recycle-bin-window";
    root.innerHTML=`
      <div class="recycle-bin-header">
        <button class="theme-btn" id="rbEmpty">Empty Recycle Bin</button>
      </div>
      <div class="rb-list" id="rbList"></div>
    `;
    root.querySelector("#rbEmpty").onclick=()=>{
      const count=OS.state.recycleBin.length;
      OS.state.recycleBin=[];
      renderRecycleBinList();
      notify("Recycle Bin",`Emptied (${count} item${count===1?"":"s"})`);
      showToast(`Recycle Bin emptied (${count})`);
    };
    renderRecycleBinList();
    return root;
  }
});
function moveToRecycleBin(icon){
  OS.state.recycleBin.push({
    name:icon.name,
    appId:icon.appId,
    time:new Date()
  });
}
function renderRecycleBinList(){
  const list=$("#rbList");
  if(!list) return;
  list.innerHTML="";
  if(OS.state.recycleBin.length===0){
    list.innerHTML=`<div class="rb-empty-msg">Recycle Bin is empty.</div>`;
    return;
  }
  OS.state.recycleBin.forEach((item,idx)=>{
    const row=document.createElement("div");
    row.className="rb-item";
    const time=item.time.toLocaleTimeString(undefined,{hour:"numeric",minute:"2-digit"});
    row.innerHTML=`
      <div>${item.name} <span style="font-size:11px;color:var(--text-sub);">(${time})</span></div>
      <div class="rb-item-actions">
        <button data-restore="${idx}">Restore</button>
        <button data-delete="${idx}">Delete</button>
      </div>
    `;
    row.querySelector(`[data-restore]`).onclick=()=>{
      const it=OS.state.recycleBin[idx];
      OS.state.desktopIcons.push({
        id:"restored-"+Date.now(),
        name:it.name,
        appId:it.appId,
        x:120,y:40,selected:false,type:"shortcut"
      });
      OS.state.recycleBin.splice(idx,1);
      renderRecycleBinList();
      renderDesktopIcons();
    };
    row.querySelector(`[data-delete]`).onclick=()=>{
      OS.state.recycleBin.splice(idx,1);
      renderRecycleBinList();
    };
    list.appendChild(row);
  });
}

registerApp("thispc",{
  title:"This PC",
  createContent(){
    const root=document.createElement("div");
    root.className="thispc-app";
    root.innerHTML=`
      <div class="thispc-nav">
        <div class="thispc-nav-item" data-view="system">System</div>
        <div class="thispc-nav-item" data-view="storage">Storage</div>
        <div class="thispc-nav-item" data-view="apps">Apps</div>
      </div>
      <div class="thispc-main" id="thispc-main"></div>
    `;
    setupThisPC(root);
    return root;
  }
});
function setupThisPC(root){
  const main=root.querySelector("#thispc-main");
  const items=$$(".thispc-nav-item",root);
  items.forEach(it=>{
    it.onclick=()=>{
      items.forEach(i=>i.classList.remove("active"));
      it.classList.add("active");
      renderThisPCView(it.dataset.view,main);
    };
  });
  items[0].classList.add("active");
  renderThisPCView("system",main);
}
function renderThisPCView(view,main){
  if(view==="system"){
    main.innerHTML=`
      <h2>System</h2>
      <p><strong>OS:</strong> Liquid Plastic OS 1.x</p>
      <p><strong>CPU:</strong> Virtual Glass Core</p>
      <p><strong>Memory:</strong> 8 GB</p>
      <p><strong>Windows:</strong> ${OS.state.windows.length}</p>
      <p><strong>Desktop Icons:</strong> ${OS.state.desktopIcons.length}</p>
    `;
  }else if(view==="storage"){
    main.innerHTML=`
      <h2>Storage</h2>
      <div style="margin-top:8px;">
        <div>LP-SSD0 (C:)</div>
        <div style="height:10px;border-radius:999px;border:1px solid rgba(148,163,184,.6);overflow:hidden;margin-top:2px;">
          <div style="width:45%;height:100%;background:linear-gradient(90deg,#22c55e,#16a34a);"></div>
        </div>
        <div style="font-size:11px;color:var(--text-sub);margin-top:2px;">45% used • 110 GB free of 200 GB</div>
      </div>
    `;
  }else if(view==="apps"){
    const appsHtml=Object.keys(OS.state.apps).map(id=>{
      const app=OS.state.apps[id];
      return `
        <div style="display:flex;align-items:center;justify-content:space-between;padding:4px 0;border-bottom:1px solid rgba(31,41,55,.9);">
          <span>${app.title} <span style="font-size:11px;color:var(--text-sub);">(${id})</span></span>
          <button class="theme-btn" data-open="${id}" style="padding:2px 8px;font-size:11px;">Open</button>
        </div>
      `;
    }).join("");
    main.innerHTML=`<h2>Installed apps</h2><div style="margin-top:8px;">${appsHtml}</div>`;
    main.querySelectorAll("[data-open]").forEach(btn=>{
      btn.onclick=()=>openApp(btn.dataset.open);
    });
  }
}

/* -------------------------
   Store with install/uninstall + delayed install UI
   ------------------------- */
registerApp("store",{
  title:"Store",
  createContent(){
    const root=document.createElement("div");
    root.className="store-app";
    root.innerHTML=`
      <h2>Store</h2>
      <div class="store-grid" id="storeGrid"></div>
    `;
    renderStoreGrid(root.querySelector("#storeGrid"));
    return root;
  }
});

const storeCatalog = [
  { id:"paint", title:"Liquid Paint", desc:"Simple drawing app for Liquid Plastic." },
  { id:"music", title:"LP Music", desc:"Music player (YT Music / Spotify iframe option)." },
  { id:"notes", title:"Notes", desc:"Simple notes app." },
  { id:"calc", title:"Calculator", desc:"Basic calculator." },
  { id:"browser", title:"LP Browser", desc:"Lightweight LP browser." }
];

function renderStoreGrid(container){
  container.innerHTML = storeCatalog.map(item=>{
    const installed = !!OS.state.apps[item.id];
    const label = installed ? "Installed" : "Install";
    return `
      <div class="store-card" data-id="${item.id}">
        <div class="store-card-title">${item.title}</div>
        <div class="store-card-desc">${item.desc}</div>
        <div class="store-card-buttons">
          <button class="theme-btn store-install" data-install="${item.id}">${installed ? "Installed" : "Install"}</button>
          <button class="theme-btn store-uninstall" data-uninstall="${item.id}">Uninstall</button>
        </div>
      </div>
    `;
  }).join("");
  container.querySelectorAll(".store-install").forEach(btn=>{
    btn.onclick=async ()=>{
      const id=btn.dataset.install;
      if(OS.state.apps[id]){
        showToast(`${id} already installed.`);
        return;
      }
      btn.textContent="Installing...";
      btn.disabled=true;
      // simulate install delay
      setTimeout(()=>{
        installStoreApp(id);
        // update UI
        renderStoreGrid(container);
      }, 900);
    };
  });
  container.querySelectorAll(".store-uninstall").forEach(btn=>{
    btn.onclick=()=>{
      const id=btn.dataset.uninstall;
      if(!OS.state.apps[id]){
        showToast(`App ${id} is not installed.`);
        return;
      }
      uninstallStoreApp(id);
      renderStoreGrid(container);
    };
  });
}

function installStoreApp(id){
  // register a few apps with functional content
  if(id==="paint" && !OS.state.apps["paint"]){
    registerApp("paint",{
      title:"Liquid Paint",
      createContent(){
        const div=document.createElement("div");
        div.innerHTML=`<div style="font-size:12px;">Liquid Paint is a concept app. Imagine a canvas here.</div>`;
        return div;
      }
    });
  }
  if(id==="music" && !OS.state.apps["music"]){
    registerApp("music",{
      title:"LP Music",
      createContent(){
        const div=document.createElement("div");
        div.style.height="100%";
        div.innerHTML=`
          <div style="display:flex;flex-direction:column;height:100%;">
            <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;">
              <label style="font-size:12px;">Source:</label>
              <select id="lpMusicSource">
                <option value="https://music.youtube.com">YouTube Music</option>
                <option value="https://open.spotify.com">Spotify</option>
              </select>
              <button id="lpMusicLoad" class="theme-btn">Load</button>
            </div>
            <div style="flex:1;border:1px solid rgba(55,65,81,.9);border-radius:8px;overflow:hidden;">
              <iframe id="lpMusicFrame" src="https://music.youtube.com" style="width:100%;height:100%;border:0;"></iframe>
            </div>
          </div>
        `;
        setTimeout(()=>{
          const sel = div.querySelector("#lpMusicSource");
          const btn = div.querySelector("#lpMusicLoad");
          const frame = div.querySelector("#lpMusicFrame");
          btn.onclick=()=>{ frame.src = sel.value; };
        },10);
        return div;
      }
    });
  }
  if(id==="notes" && !OS.state.apps["notes"]){
    registerApp("notes",{
      title:"Notes",
      createContent(){
        const div=document.createElement("div");
        div.innerHTML=`<textarea class="notes-area" placeholder="Notes..."></textarea>`;
        return div;
      }
    });
  }
  if(id==="calc" && !OS.state.apps["calc"]){
    registerApp("calc",{
      title:"Calculator",
      createContent(){
        const div=document.createElement("div");
        div.innerHTML=`<div style="font-size:12px;">Calculator (simple)</div>`;
        return div;
      }
    });
  }
  if(id==="browser" && !OS.state.apps["browser"]){
    registerApp("browser",{
      title:"LP Browser",
      createContent(){
        const div=document.createElement("div");
        div.innerHTML=`<div style="font-size:12px;">LP Browser (light)</div>`;
        return div;
      }
    });
  }

  // add to pinned apps after a short delay so Start shows installing animation
  setTimeout(()=>{
    if(!pinnedApps.includes(id)) pinnedApps.push(id);
    notify("Store",`Installed ${id} and added to Start.`);
    showToast(`Installed ${id}`);
    if(OS.state.startMenuOpen) renderStartMenuContent();
  }, 350);
}

function uninstallStoreApp(id){
  if(!OS.state.apps[id]){
    showToast(`App ${id} is not installed.`);
    return;
  }
  // close any open windows of that app
  OS.state.windows.forEach(win=>{
    if(win.dataset.appId===id) win.remove();
  });
  OS.state.windows=OS.state.windows.filter(w=>w.dataset.appId!==id);
  if(OS.state.activeWindow && OS.state.activeWindow.dataset.appId===id){
    OS.state.activeWindow=null;
  }
  // remove from registry
  delete OS.state.apps[id];
  // unpin from start
  pinnedApps=pinnedApps.filter(a=>a!==id);
  // remove desktop shortcuts pointing to that app
  OS.state.desktopIcons=OS.state.desktopIcons.filter(i=>i.appId!==id);
  renderDesktopIcons();
  renderTaskbar();
  notify("Store",`Uninstalled ${id}.`);
  showToast(`Uninstalled ${id}`);
  if(OS.state.startMenuOpen) renderStartMenuContent();
}

/* -------------------------
   Terminal
   ------------------------- */
registerApp("terminal",{
  title:"Terminal",
  createContent(){
    const root=document.createElement("div");
    root.innerHTML=`
      <pre style="font-family:monospace;font-size:12px;background:#020617;padding:6px;border-radius:8px;border:1px solid rgba(55,65,81,.9);height:100%;overflow:auto;">
Liquid Plastic Shell 1.x

> help
  apps        List installed apps
  open NAME   Open app by id
  clear       Clear screen

> _</pre>
    `;
    return root;
  }
});

/* -------------------------
   Task Manager
   ------------------------- */
registerApp("taskmgr",{
  title:"Task Manager",
  createContent(){
    const root=document.createElement("div");
    root.style.fontSize="12px";
    renderTaskManagerContent(root);
    return root;
  }
});
function renderTaskManagerContent(root){
  const rows=OS.state.windows.map(win=>{
    const id=win.dataset.appId;
    const app=OS.state.apps[id];
    return `
      <tr>
        <td>${app?app.title:id}</td>
        <td>${id}</td>
        <td><button class="theme-btn" data-kill="${id}" style="padding:2px 8px;font-size:11px;">End task</button></td>
      </tr>
    `;
  }).join("");
  root.innerHTML=`
    <h2>Task Manager</h2>
    <table style="width:100%;border-collapse:collapse;margin-top:6px;">
      <thead>
        <tr style="border-bottom:1px solid rgba(55,65,81,.9);">
          <th style="text-align:left;padding:4px;">Name</th>
          <th style="text-align:left;padding:4px;">ID</th>
          <th style="text-align:left;padding:4px;">Action</th>
        </tr>
      </thead>
      <tbody>
        ${rows || `<tr><td colspan="3" style="padding:4px;font-size:12px;color:var(--text-sub);">No running apps.</td></tr>`}
      </tbody>
    </table>
  `;
  root.querySelectorAll("[data-kill]").forEach(btn=>{
    btn.onclick=()=>{
      const id=btn.dataset.kill;
      const win=OS.state.windows.find(w=>w.dataset.appId===id);
      if(win){
        win.remove();
        OS.state.windows=OS.state.windows.filter(w=>w!==win);
        if(OS.state.activeWindow===win) OS.state.activeWindow=null;
        renderTaskbar();
        notify("Task Manager",`Closed ${id}`);
        renderTaskManagerContent(root);
      }
    };
  });
}

/* -------------------------
   Taskbar + clock
   ------------------------- */
function renderTaskbar(){
  const bar=$("#taskbar");
  if(!bar) return;
  bar.innerHTML="";

  const left=document.createElement("div");
  left.className="task-left";
  left.innerHTML=`<button class="task-btn" id="btnStart">Start</button>`;

  const mid=document.createElement("div");
  mid.className="task-mid taskbar-apps";
  OS.state.windows.forEach(win=>{
    const appId=win.dataset.appId;
    const app=OS.state.apps[appId];
    const btn=document.createElement("div");
    btn.className="tb-app";
    if(win.style.display!=="none"){
      btn.classList.add("active");
    }
    btn.dataset.appId=appId;
    btn.textContent=app?app.title:appId;
    btn.onclick=()=>{
      if(win.style.display==="none"){
        win.style.display="flex";
        focusWindow(win);
      }else if(OS.state.activeWindow===win){
        win.style.display="none";
      }else{
        focusWindow(win);
      }
      renderTaskbar();
    };
    mid.appendChild(btn);
  });

  const right=document.createElement("div");
  right.className="task-right";
  const notifBtn=document.createElement("button");
  notifBtn.className="task-btn";
  notifBtn.id="btnNotif";
  notifBtn.innerHTML=`<span>Notifications</span>`;
  const clock=document.createElement("div");
  clock.className="task-clock";
  clock.innerHTML=`<div id="tbTime">--:--</div><div class="date" id="tbDate">--/--/----</div>`;
  right.appendChild(clock);
  right.appendChild(notifBtn);

  bar.appendChild(left);
  bar.appendChild(mid);
  bar.appendChild(right);

  $("#btnStart").onclick=(e)=>{
    e.stopPropagation();
    toggleStartMenu();
  };
  $("#btnNotif").onclick=(e)=>{
    e.stopPropagation();
    toggleNotifPanel();
  };

  updateClock();
}
function updateClock(){
  if(!OS.state.bootDone) return;
  const now=new Date();
  const use24=OS.config.clock24;
  let h24=now.getHours();
  let h=h24%12||12;
  const m=String(now.getMinutes()).padStart(2,"0");
  const ampm=h24>=12?"PM":"AM";
  const t=$("#tbTime");
  const d=$("#tbDate");
  if(t) t.textContent = use24 ? `${String(h24).padStart(2,"0")}:${m}` : `${h}:${m} ${ampm}`;
  if(d) d.textContent=`${now.getMonth()+1}/${now.getDate()}/${now.getFullYear()}`;
}
setInterval(updateClock,30000);

/* -------------------------
   Notifications panel
   ------------------------- */
function renderNotifications(){
  if(!OS.state.bootDone) return;
  const panel=$("#notifPanel .inner");
  if(!panel) return;
  const list=document.createElement("div");
  list.className="notif-list";
  if(OS.state.notifications.length===0){
    list.innerHTML=`<div class="notif">No notifications.</div>`;
  }else{
    OS.state.notifications.forEach(n=>{
      const div=document.createElement("div");
      div.className="notif";
      const time=n.time.toLocaleTimeString(undefined,{hour:"numeric",minute:"2-digit"});
      div.innerHTML=`
        <div class="notif-title">${n.title}</div>
        <div>${n.message}</div>
        <div class="notif-time">${time}</div>
        <div class="notif-close">×</div>
      `;
      div.querySelector(".notif-close").onclick=()=>{
        OS.state.notifications=OS.state.notifications.filter(nn=>nn.id!==n.id);
        renderNotifications();
      };
      list.appendChild(div);
    });
  }
  const tools=document.createElement("div");
  tools.style.display="flex";
  tools.style.justifyContent="space-between";
  tools.style.fontSize="11px";
  tools.style.marginBottom="4px";
  tools.innerHTML=`<span>Notifications</span><span id="notifClear" style="cursor:pointer;color:var(--accent);">Clear all</span>`;
  panel.innerHTML="";
  panel.appendChild(tools);
  panel.appendChild(list);
  $("#notifClear").onclick=()=>{
    OS.state.notifications=[];
    renderNotifications();
  };
}
function toggleNotifPanel(force){
  const p=$("#notifPanel");
  if(!p) return;
  if(typeof force==="boolean") OS.state.notifOpen=force;
  else OS.state.notifOpen=!OS.state.notifOpen;
  if(OS.state.notifOpen){
    renderNotifications();
    p.style.display="block";
  }else{
    p.style.display="none";
  }
}

/* -------------------------
   Start menu + pinned apps
   ------------------------- */
let pinnedApps=["browser","settings","notes","store","terminal","calculator","taskmgr","thispc","recycle-bin"];
let currentDraggedAppId=null;

function renderStartMenuContent(){
  const inner=$("#startMenu .inner");
  if(!inner) return;
  inner.innerHTML=`
    <div class="start-header">
      <div class="start-account" id="startAccountBtn">
        <div class="start-account-avatar">C</div>
        <div class="start-account-text">
          <span class="start-account-name">Curtis</span>
          <span class="start-account-sub">Liquid Plastic</span>
        </div>
      </div>
      <div class="start-header-right">
        <button id="btnTaskMgr">Task Manager</button>
      </div>
    </div>
    <div class="start-grid" id="startGrid"></div>
    <div class="start-footer">
      <button id="startLock">Lock</button>
      <button id="startSignOut">Sign out</button>
      <button id="startShutdown">Shut down</button>
    </div>
  `;
  const grid=$("#startGrid");
  grid.innerHTML="";
  pinnedApps.forEach(id=>{
    const app=OS.state.apps[id];
    if(!app) return;
    const tile=document.createElement("div");
    tile.className="start-tile";
    tile.dataset.appId=id;
    tile.innerHTML=`
      <div class="start-icon"></div>
      <div>${app.title}</div>
    `;
    tile.onclick=(e)=>{
      if(e.ctrlKey||e.metaKey) return;
      openApp(id);
      toggleStartMenu(false);
    };
    tile.draggable=true;
    tile.addEventListener("dragstart",(e)=>{
      currentDraggedAppId=id;
      e.dataTransfer.effectAllowed="copy";
    });
    grid.appendChild(tile);
  });

  $("#startAccountBtn").onclick=()=>{
    const win=openApp("settings");
    if(!win) return;
    setTimeout(()=>{
      const item=[...$$(".settings-item",win)].find(el=>el.dataset.panel==="account");
      if(item) item.click();
    },10);
  };
  $("#btnTaskMgr").onclick=()=>{ openApp("taskmgr"); };
  $("#startLock").onclick=()=>{
    minimizeAllWindows();
    toggleStartMenu(false);
    showLockscreen(false);
  };
  $("#startSignOut").onclick=()=>{
    minimizeAllWindows();
    toggleStartMenu(false);
    showLockscreen(false);
  };
  $("#startShutdown").onclick=()=>{
    minimizeAllWindows();
    toggleStartMenu(false);
    notify("System","Shutdown is simulated in this build.");
    showToast("Shutdown is simulated in this build.");
  };
}
function toggleStartMenu(force){
  const m=$("#startMenu");
  if(!m) return;
  if(typeof force==="boolean") OS.state.startMenuOpen=force;
  else OS.state.startMenuOpen=!OS.state.startMenuOpen;
  if(OS.state.startMenuOpen){
    renderStartMenuContent();
    m.style.display="block";
  }else{
    m.style.display="none";
  }
}
function togglePinStart(appId){
  if(!appId) return;
  if(pinnedApps.includes(appId)){
    pinnedApps=pinnedApps.filter(id=>id!==appId);
    notify("Start","App unpinned from Start.");
  }else{
    pinnedApps.push(appId);
    notify("Start","App pinned to Start.");
  }
  if(OS.state.startMenuOpen) renderStartMenuContent();
}

/* Drag from Start → Desktop */
const desktopEl=document.querySelector(".desktop");
if(desktopEl){
  desktopEl.addEventListener("dragover",(e)=>{
    if(currentDraggedAppId) e.preventDefault();
  });
  desktopEl.addEventListener("drop",(e)=>{
    if(!currentDraggedAppId) return;
    e.preventDefault();
    const rect=desktopEl.getBoundingClientRect();
    const x=e.clientX-rect.left;
    const y=e.clientY-rect.top;
    const app=OS.state.apps[currentDraggedAppId];
    OS.state.desktopIcons.push({
      id:"shortcut-"+Date.now(),
      name:app?app.title:currentDraggedAppId,
      appId:currentDraggedAppId,
      x:x-30,y:y-30,
      selected:false,
      type:"shortcut"
    });
    currentDraggedAppId=null;
    renderDesktopIcons();
  });
}

/* -------------------------
   Minimize all windows
   ------------------------- */
function minimizeAllWindows(){
  OS.state.windows.forEach(w=>w.style.display="none");
  renderTaskbar();
}

/* -------------------------
   Global auto-close menus (don't close when clicking inside ctxMenu)
   ------------------------- */
document.addEventListener("mousedown",(e)=>{
  if(!e.target.closest("#startMenu") && !e.target.closest("#taskbar")){
    toggleStartMenu(false);
  }
  if(!e.target.closest("#notifPanel") && !e.target.closest("#taskbar")){
    toggleNotifPanel(false);
  }
  if(!e.target.closest("#ctxMenu")){
    $("#ctxMenu").style.display="none";
  }
});

/* -------------------------
   Taskbar / Start / app right-click
   ------------------------- */
document.addEventListener("contextmenu",(e)=>{
  const iconEl=e.target.closest(".icon");
  if(iconEl) return; // desktop icons handled separately

  const tbBtn=e.target.closest(".tb-app");
  const tb=e.target.closest("#taskbar");
  const startBtn=e.target.closest("#btnStart");
  const startMenuEl=e.target.closest("#startMenu");

  if(tbBtn){
    e.preventDefault();
    showTaskbarAppContextMenu(tbBtn,e.clientX,e.clientY);
    return;
  }
  if(startBtn){
    e.preventDefault();
    showSimpleContextMenu("Start menu settings (placeholder)",e.clientX,e.clientY);
    return;
  }
  if(tb && !tbBtn){
    e.preventDefault();
    showSimpleContextMenu("Taskbar settings (placeholder)",e.clientX,e.clientY);
    return;
  }
  if(startMenuEl){
    e.preventDefault();
    showSimpleContextMenu("Start menu settings (placeholder)",e.clientX,e.clientY);
    return;
  }
});
function showSimpleContextMenu(label,x,y){
  const menu=$("#ctxMenu");
  const inner=menu.querySelector(".inner");
  inner.innerHTML=`<div class="ctx-item">${label}</div>`;
  menu.style.left=x+"px";
  menu.style.top=y+"px";
  menu.style.display="block";
}
function showTaskbarAppContextMenu(tbBtn,x,y){
  const appId=tbBtn.dataset.appId;
  const win=OS.state.windows.find(w=>w.dataset.appId===appId);
  if(!win) return;
  const menu=$("#ctxMenu");
  const inner=menu.querySelector(".inner");
  inner.innerHTML=`<div class="ctx-item" data-act="close">Close</div>`;
  menu.style.left=x+"px";
  menu.style.top=y+"px";
  menu.style.display="block";
  inner.querySelector("[data-act='close']").onclick=()=>{
    win.remove();
    OS.state.windows=OS.state.windows.filter(w=>w!==win);
    if(OS.state.activeWindow===win) OS.state.activeWindow=null;
    renderTaskbar();
    menu.style.display="none";
  };
}

/* -------------------------
   Init desktop
   ------------------------- */
function initDesktop(){
  seedDesktopIcons();
  renderDesktopIcons();
  enableSelectionBox();
  enableIconDragging();
  renderTaskbar();
  // apply persisted glass level to UI on init
  const v = Math.round((OS.config.glassLevel||0.8)*100);
  document.documentElement.style.setProperty("--glass-opacity", String(OS.config.glassLevel));
  document.documentElement.style.setProperty("--glass-border-alpha", String(0.3 + 0.4*OS.config.glassLevel));
  document.documentElement.style.setProperty("--icon-glass-opacity", String(0.5 + 0.5*OS.config.glassLevel));
}

/* -------------------------
   DOM ready
   ------------------------- */
document.addEventListener("DOMContentLoaded", startBoot);

/* -------------------------
   Pre-register core apps so Start menu has content
   ------------------------- */
registerApp("settings",{
  title:"Settings",
  createContent(){
    const root=document.createElement("div");
    root.className="settings-app";
    root.innerHTML=`<div style="padding:8px;">Settings</div>`;
    // actual settings window is registered earlier; this placeholder ensures Start shows it
    return root;
  }
});
registerApp("store",{title:"Store",createContent(){ const d=document.createElement("div"); d.innerHTML="<div>Store</div>"; return d;}});
registerApp("thispc",{title:"This PC",createContent(){ const d=document.createElement("div"); d.innerHTML="<div>This PC</div>"; return d;}});
registerApp("terminal",{title:"Terminal",createContent(){ const d=document.createElement("div"); d.innerHTML="<div>Terminal</div>"; return d;}});
registerApp("notes",{title:"Notes",createContent(){ const d=document.createElement("div"); d.innerHTML="<div>Notes</div>"; return d;}});
registerApp("calculator",{title:"Calculator",createContent(){ const d=document.createElement("div"); d.innerHTML="<div>Calculator</div>"; return d;}});

/* End of script */
</script>
</body>
</html>
